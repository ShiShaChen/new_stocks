# 资金流水与账户余额集成功能测试指南

## 功能概述

本文档用于测试股票买入（中签）和卖出时，所有费用与账户余额关联的完整功能。包括：
- 申购金额、手续费与账户余额的关联
- 卖出收入、卖出手续费的记录
- 资金流水的时间排序
- 编辑记录时费用明细的保留
- 负数余额的正确显示

## 核心实现逻辑

### 1. 资金流水类型
- `allot`: 中签申购金额扣款
- `allot_refund`: 中签申购金额回滚
- `fee_deduction`: 手续费扣除（买入/卖出）
- `fee_refund`: 手续费回滚（修改记录时）
- `sell`: 卖出收入增加
- `sell_refund`: 卖出收入回滚

### 2. 费用分离记录
- 申购金额和手续费分别记录到资金流水
- 卖出收入和卖出手续费分别记录到资金流水
- 每种类型独立计算，避免重复扣费

### 3. 时间排序逻辑
- 手续费记录时间延后1秒，避免与主记录冲突
- 多级排序：业务时间 → 创建时间 → 记录ID → 描述内容
- 主交易优先显示，费用记录次之

## 测试场景

### 场景1：正常中签流程
1. **创建打新记录**
   - 填写股票信息：新股申购
   - 申购股数、价格、账户选择
   - 检查申购费用是否正确扣除

2. **录入中签结果**
   - 进入中签结果页面
   - 填写中签股数、日期
   - 检查以下资金流水记录：
     - `allot`: 申购金额扣款（发行价 × 中签股数）
     - `fee_deduction`: 手续费扣款（延后1秒）
   - 检查账户余额是否正确减少

3. **录入卖出信息**
   - 进入卖出记录页面
   - 填写卖出价格、股数、日期
   - 检查以下资金流水记录：
     - `sell`: 卖出收入增加（卖出价 × 卖出股数）
     - `fee_deduction`: 卖出手续费扣款（延后1秒）
   - 检查账户余额是否正确增加

### 场景2：修改中签记录
1. **修改中签股数**
   - 重新进入中签结果页面
   - 修改中签股数（增加或减少）
   - 检查是否先回滚原记录：
     - `allot_refund`: 回滚原申购金额
     - `fee_refund`: 回滚原手续费
   - 检查是否重新记录新数据：
     - `allot`: 新申购金额扣款
     - `fee_deduction`: 新手续费扣款

### 场景3：修改卖出记录
1. **修改卖出价格或股数**
   - 重新进入卖出记录页面
   - 修改卖出价格或股数
   - 检查是否先回滚原记录：
     - `sell_refund`: 回滚原卖出收入
     - `fee_refund`: 回滚原卖出手续费
   - 检查是否重新记录新数据：
     - `sell`: 新卖出收入增加
     - `fee_deduction`: 新卖出手续费扣款

### 场景4：编辑打新记录
1. **编辑已有中签和卖出的记录**
   - 进入编辑页面
   - 修改基本信息（股票名称、发行价等）
   - 保存后检查：
     - 费用明细是否保留（`winningFeeDetails`、`sellFeeDetails`）
     - 盈亏计算是否保持精确（不被覆盖）
     - 资金流水记录是否保持完整

### 场景5：快速录入测试
1. **同一时间多笔交易**
   - 在同一分钟内录入多个股票的中签/卖出
   - 检查资金流水排序是否正确
   - 主交易记录是否优先显示
   - 费用记录是否正确排在后面

### 场景6：负数余额测试
1. **余额不足时的交易**
   - 设置账户余额较低
   - 录入较大金额的中签
   - 检查余额是否可以为负数
   - 检查负数是否正确显示（带负号）

## 检查要点

### 资金流水检查
- [ ] 每笔中签产生2条记录（申购金额 + 手续费）
- [ ] 每笔卖出产生2条记录（卖出收入 + 手续费）
- [ ] 修改记录时先回滚，再重新记录
- [ ] 时间排序正确，手续费记录在主记录后面
- [ ] 金额精度保持2位小数

### 账户余额检查
- [ ] 余额计算正确（所有流水类型影响计算）
- [ ] 支持负数余额
- [ ] 负数余额正确显示负号
- [ ] 修改记录后余额更新正确

### 费用明细检查
- [ ] 中签费用明细保存到`winningFeeDetails`
- [ ] 卖出费用明细保存到`sellFeeDetails`
- [ ] 编辑记录时费用明细不丢失
- [ ] 盈亏计算智能判断，避免覆盖精确结果

### 界面显示检查
- [ ] 资金详情页面按时间倒序显示
- [ ] 负数金额带负号显示
- [ ] 费用明细在各页面正确显示
- [ ] 编辑页面数据回显正确

## 常见问题排查

### 问题1：资金流水重复
**症状**：同一笔交易产生多条相同记录
**检查**：
- 是否多次点击保存按钮
- 是否存在重复的事件处理

### 问题2：余额计算错误
**症状**：余额与预期不符
**检查**：
- 检查所有流水类型是否正确处理
- 检查回滚逻辑是否完整
- 检查金额精度处理

### 问题3：排序异常
**症状**：资金流水排序混乱
**检查**：
- 检查时间戳是否正确设置
- 检查多级排序逻辑
- 检查手续费记录时间延后

### 问题4：费用明细丢失
**症状**：编辑后费用明细消失
**检查**：
- 检查保存逻辑是否保留费用字段
- 检查字段名称是否正确

## 测试数据示例

### 测试股票信息
```
股票名称：测试股票A
发行价：10.00 HKD
申购股数：1000股
中签股数：500股
卖出价：15.00 HKD
卖出股数：500股
```

### 预期资金流水
```
1. 申购金额扣款：-5000.00 HKD (10.00 × 500)
2. 申购手续费：-费用明细总额 HKD
3. 卖出收入：+7500.00 HKD (15.00 × 500)
4. 卖出手续费：-费用明细总额 HKD
```

### 预期账户余额变化
```
初始余额：10000.00 HKD
中签后：10000.00 - 5000.00 - 申购手续费
卖出后：上述金额 + 7500.00 - 卖出手续费
```

## 总结

本测试指南涵盖了资金流水与账户余额集成的所有核心功能。通过系统性的测试，可以确保：
1. 资金流水记录完整准确
2. 账户余额计算正确
3. 费用明细不丢失
4. 时间排序稳定
5. 负数显示正确

定期执行这些测试可以保证系统的稳定性和数据一致性。
