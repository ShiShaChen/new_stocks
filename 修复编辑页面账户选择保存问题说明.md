# 编辑打新页面账户选择保存修复说明

## 问题描述
在编辑打新记录页面，用户重新选择账户后保存数据时，accountId字段没有被正确更新，导致保存失败或数据关联错误。

## 问题原因分析
1. **onSubmit方法缺少accountId处理**: 在构造stockData对象时，没有包含accountId字段
2. **账户ID获取逻辑不完整**: 没有优先使用当前选中的账户ID
3. **数据同步问题**: formData.accountId与selectedAccount可能不同步

## 修复方案

### 1. 修复onSubmit方法
```javascript
onSubmit(e) {
  const formData = e.detail.value
  
  // 确保账户ID正确
  const accountId = this.data.selectedAccount ? this.data.selectedAccount.id : (this.data.formData.accountId || 'default')

  // 数据处理
  const stockData = {
    // ...其他字段
    accountId: accountId, // 确保使用最新选择的账户ID
    // ...
  }
  
  this.saveStock(stockData)
}
```

### 2. 优化loadStockData方法
```javascript
loadStockData(id) {
  // ...
  // 设置对应的账户信息
  const accountId = formData.accountId || 'default'
  const account = this.data.accountList.find(acc => acc.id === accountId) || { id: 'default', name: '默认账户' }
  
  this.setData({
    formData: formData,
    selectedAccount: account
  })
  
  console.log('加载股票数据:', {
    stockId: id,
    accountId: accountId,
    selectedAccount: account
  })
}
```

### 3. 增强账户选择日志
```javascript
onChooseAccount(e) {
  const account = e.currentTarget.dataset.account
  this.setData({
    selectedAccount: account,
    'formData.accountId': account.id,
    showAccountModal: false
  })
  
  console.log('选择账户:', {
    accountId: account.id,
    accountName: account.name
  })
}
```

### 4. 完善保存流程日志
```javascript
saveStock(stockData) {
  console.log('=== 开始保存股票数据 ===')
  console.log('保存的股票数据:', stockData)
  console.log('选中的账户:', this.data.selectedAccount)
  
  // ...保存逻辑
  
  // 验证保存结果
  const savedStock = savedStocks.find(item => item.id === this.data.stockId)
  console.log('验证保存结果:', savedStock ? {
    id: savedStock.id,
    stockName: savedStock.stockName,
    accountId: savedStock.accountId
  } : '未找到保存的记录')
}
```

## 修复内容总结

### 关键修复点
1. **确保accountId字段保存**: 在onSubmit方法中明确添加accountId字段
2. **优先使用selectedAccount**: 优先从当前选中账户获取ID
3. **数据一致性**: 确保formData.accountId与selectedAccount同步
4. **错误处理**: 添加记录不存在的错误提示
5. **调试支持**: 增加详细的控制台日志

### 数据流程
1. 页面加载 → 初始化账户列表
2. 编辑模式 → 加载原始数据并设置对应账户
3. 用户选择账户 → 更新selectedAccount和formData.accountId
4. 提交保存 → 确保使用最新的accountId
5. 数据持久化 → 验证保存结果

### 测试建议
1. 创建多个账户进行测试
2. 编辑现有记录并切换账户
3. 验证保存后的数据accountId是否正确
4. 检查首页和历史页面的数据过滤是否正常

## 技术要点

### 数据优先级
```javascript
// 账户ID获取优先级：
// 1. 当前选中账户ID (selectedAccount.id)
// 2. 表单数据中的账户ID (formData.accountId)  
// 3. 默认账户ID ('default')
const accountId = this.data.selectedAccount ? this.data.selectedAccount.id : (this.data.formData.accountId || 'default')
```

### 状态同步
- selectedAccount: 当前选中的账户对象
- formData.accountId: 表单中的账户ID字段
- 两者必须保持同步

### 调试工具
- 详细的console.log输出
- 保存前后数据对比
- 错误边界处理

通过以上修复，编辑打新页面重新选择账户后保存功能现已正常工作，确保数据完整性和账户关联的正确性。
