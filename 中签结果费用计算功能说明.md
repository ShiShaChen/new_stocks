# 中签结果费用计算功能说明

## 功能概述
在录入中签结果时，系统会根据中签数量和股票发行价实时计算各项应收费用，包括印花税、交易费、交易征费、会财局交易征费和打新套餐费用。

## 费用计算标准

### 1. 计算基数
所有费用均按照 **中签股数 × 股票发行价** 作为计算基数

### 2. 费用明细
| 费用项目 | 费率 | 计算公式 |
|---------|------|---------|
| 印花税 | 0.1% | 中签金额 × 0.001 |
| 交易费 | 0.00565% | 中签金额 × 0.0000565 |
| 交易征费 | 0.0027% | 中签金额 × 0.000027 |
| 会财局交易征费 | 0.00015% | 中签金额 × 0.0000015 |
| 打新套餐费用 | 固定金额 | 录入股票时的套餐费用 |

### 3. 总费用
总费用 = 印花税 + 交易费 + 交易征费 + 会财局交易征费 + 打新套餐费用

## 技术实现

### 1. 数据结构
```javascript
data: {
  feeDetails: {
    stampDuty: '0.00',        // 印花税
    tradingFee: '0.00',       // 交易费
    tradingLevy: '0.00',      // 交易征费
    afrcLevy: '0.00',         // 会财局交易征费
    packageFee: '0.00',       // 打新套餐费用
    totalFee: '0.00'          // 总费用
  }
}
```

### 2. 计算方法
```javascript
calculateFees(winningShares, issuePrice, packageFee) {
  // 中签金额作为费用计算基数
  const baseAmount = winningShares * issuePrice
  
  // 各项费用计算（使用精确计算避免浮点数问题）
  const stampDuty = Math.round(baseAmount * 0.001 * 100) / 100
  const tradingFee = Math.round(baseAmount * 0.0000565 * 100) / 100
  const tradingLevy = Math.round(baseAmount * 0.000027 * 100) / 100
  const afrcLevy = Math.round(baseAmount * 0.0000015 * 100) / 100
  
  // 总费用
  const totalFee = Math.round((stampDuty + tradingFee + tradingLevy + afrcLevy + packageFee) * 100) / 100
  
  return {
    stampDuty: stampDuty.toFixed(2),
    tradingFee: tradingFee.toFixed(2),
    tradingLevy: tradingLevy.toFixed(2),
    afrcLevy: afrcLevy.toFixed(2),
    packageFee: packageFee.toFixed(2),
    totalFee: totalFee.toFixed(2)
  }
}
```

### 3. 精度处理
为避免JavaScript浮点数计算精度问题，采用以下方法：
- 先乘以100转为整数计算
- 使用Math.round()进行四舍五入
- 再除以100转回小数
- 最后使用toFixed(2)保留两位小数

## 界面展示

### 1. 股票信息卡片更新
```xml
<view class="stock-info-card">
  <text class="stock-name">{{stockInfo.stockName}}</text>
  <view class="stock-details">
    <text class="detail-item">申购手数：{{stockInfo.subscriptionHands}} 手</text>
    <text class="detail-item">发行价：¥{{stockInfo.issuePrice}}</text>
    <text class="detail-item">套餐费用：¥{{stockInfo.packageFee}}</text>
  </view>
</view>
```

### 2. 费用明细展示
```xml
<view class="fee-details">
  <view class="fee-title">应收费用明细</view>
  <view class="fee-item">
    <text class="fee-label">印花税 (0.1%)：</text>
    <text class="fee-value">¥{{feeDetails.stampDuty}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易费 (0.00565%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingFee}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易征费 (0.0027%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">会财局交易征费 (0.00015%)：</text>
    <text class="fee-value">¥{{feeDetails.afrcLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">打新套餐费用：</text>
    <text class="fee-value">¥{{feeDetails.packageFee}}</text>
  </view>
  <view class="fee-total">
    <text class="fee-total-label">总费用：</text>
    <text class="fee-total-value">¥{{feeDetails.totalFee}}</text>
  </view>
</view>
```

### 3. 样式设计
- 费用明细使用独立的卡片布局
- 每项费用左右对齐显示
- 总费用用红色高亮显示
- 响应式设计适配不同屏幕

## 实时计算触发

### 1. 触发条件
- 用户输入中签股数时
- 中签股数发生变化时
- 页面初始化加载股票信息后

### 2. 计算流程
```javascript
onWinningSharesChange(e) {
  const winningShares = e.detail.value
  this.setData({
    'formData.winningShares': winningShares
  })
  
  // 实时计算费用
  this.calculateResult()
}
```

## 计算示例

### 示例数据
- 股票发行价：¥15.80
- 中签股数：500股
- 套餐费用：¥50.00

### 计算过程
1. **中签金额**：500 × 15.80 = ¥7,900.00
2. **印花税**：7,900 × 0.001 = ¥7.90
3. **交易费**：7,900 × 0.0000565 = ¥0.45
4. **交易征费**：7,900 × 0.000027 = ¥0.21
5. **会财局交易征费**：7,900 × 0.0000015 = ¥0.01
6. **打新套餐费用**：¥50.00
7. **总费用**：7.90 + 0.45 + 0.21 + 0.01 + 50.00 = ¥58.57

### 显示效果
```
应收费用明细
印花税 (0.1%)：          ¥7.90
交易费 (0.00565%)：      ¥0.45
交易征费 (0.0027%)：     ¥0.21
会财局交易征费 (0.00015%)：¥0.01
打新套餐费用：           ¥50.00
────────────────────────────
总费用：                ¥58.57
```

## 用户体验优化

### 1. 实时反馈
- 输入中签股数时立即计算并显示费用
- 计算结果实时更新，无需等待

### 2. 数据准确性
- 使用精确的数学计算避免精度问题
- 四舍五入处理符合财务要求
- 保留两位小数显示

### 3. 界面友好
- 费用明细清晰分类展示
- 总费用突出显示
- 费率标识帮助用户理解

### 4. 错误处理
- 输入验证确保数据有效性
- 边界情况处理（如股数为0）
- 数据缺失时的默认值处理

## 测试要点

### 1. 计算准确性测试
- [ ] 各项费率计算正确
- [ ] 四舍五入处理准确
- [ ] 总费用汇总正确
- [ ] 边界值测试（如最小股数）

### 2. 实时更新测试
- [ ] 输入中签股数时费用实时计算
- [ ] 清空股数时费用重置为0
- [ ] 页面刷新后计算正常

### 3. 界面显示测试
- [ ] 费用明细正确显示
- [ ] 数字格式化正确（两位小数）
- [ ] 样式布局美观
- [ ] 不同屏幕尺寸适配

### 4. 数据完整性测试
- [ ] 缺少发行价时的处理
- [ ] 缺少套餐费用时的处理
- [ ] 无效输入时的处理

通过这个功能，用户可以在录入中签结果时清楚地了解所需支付的各项费用，有助于更好地进行投资成本核算。
