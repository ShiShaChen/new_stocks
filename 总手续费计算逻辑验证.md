# 总手续费计算逻辑验证

## 费用构成明确化

### 修正前的问题
- 界面上显示了两个"总费用"，容易混淆
- 买入费用没有单独显示，用户不清楚费用构成

### 修正后的显示结构

#### 1. 卖出费用明细卡片
```
卖出费用明细
├── 佣金：¥75.00
├── 印花税 (0.1%)：¥X.XX
├── 交易徵费 (0.00285%)：¥X.XX
├── 交易费 (0.00565%)：¥X.XX
├── 结算费 (0.002%，最低¥3)：¥X.XX
└── 卖出费用小计：¥X.XX
```

#### 2. 盈亏计算结果
```
├── 卖出金额：¥X.XX
├── 成本金额：¥X.XX
├── 买入费用：¥X.XX (serviceFee + packageFee 按比例)
├── 卖出费用：¥X.XX (等于上面的"卖出费用小计")
├── 总手续费：¥X.XX (买入费用 + 卖出费用)
├── 净盈亏：¥X.XX
└── 收益率：X.XX%
```

## 计算公式验证

### 总手续费计算
```javascript
// 买入费用（按比例分摊）
const buyFeeRatio = sellShares / stockInfo.winningShares
const buyFees = (serviceFee + packageFee) * buyFeeRatio

// 卖出费用（实时计算）
const sellFees = calculateSellFees(sellShares, sellPrice)

// 总手续费
const totalFees = buyFees + parseFloat(sellFees.totalFee)
```

### 净盈亏计算
```javascript
const profit = sellAmount - costAmount - totalFees
```

### 示例计算（1000股，卖出价10港元）

#### 假设数据
- 中签股数：1000股
- 发行价：8港元
- 卖出价：10港元
- 卖出股数：1000股
- 买入时服务费：100港元
- 买入时套餐费：50港元

#### 买入费用
```
买入费用比例 = 1000 / 1000 = 1.0
买入费用 = (100 + 50) × 1.0 = 150.00港元
```

#### 卖出费用
```
卖出金额 = 1000 × 10 = 10,000港元

佣金 = 75.00港元
印花税 = 10,000 × 0.001 = 10.00港元
交易徵费 = 10,000 × 0.0000285 = 0.29港元
交易费 = 10,000 × 0.0000565 = 0.57港元
结算费 = max(10,000 × 0.00002, 3.00) = max(0.20, 3.00) = 3.00港元

卖出费用小计 = 75.00 + 10.00 + 0.29 + 0.57 + 3.00 = 88.86港元
```

#### 总计算
```
卖出金额 = 10,000.00港元
成本金额 = 8,000.00港元
买入费用 = 150.00港元
卖出费用 = 88.86港元
总手续费 = 150.00 + 88.86 = 238.86港元

净盈亏 = 10,000.00 - 8,000.00 - 238.86 = 1,761.14港元
收益率 = (1,761.14 / 8,000.00) × 100% = 22.01%
```

## 界面显示验证

### 检查要点
1. **卖出费用明细卡片**
   - [ ] 显示"卖出费用小计"而不是"总费用"
   - [ ] 各项费用计算正确
   - [ ] 小计等于各项费用之和

2. **盈亏计算结果**
   - [ ] 买入费用单独显示
   - [ ] 卖出费用等于上面的小计
   - [ ] 总手续费 = 买入费用 + 卖出费用
   - [ ] 净盈亏计算正确

3. **数据一致性**
   - [ ] 各处显示的同一数据保持一致
   - [ ] 精度处理统一（两位小数）
   - [ ] 计算逻辑清晰可追踪

## 测试用例

### 测试用例1：部分卖出
- 中签1000股，卖出500股
- 验证买入费用按比例分摊
- 验证卖出费用按实际卖出计算

### 测试用例2：结算费最低限制
- 小额交易（如100股×5港元）
- 验证结算费是否正确应用3港元最低限制

### 测试用例3：精度处理
- 验证所有计算结果保留两位小数
- 验证四舍五入处理正确

---
*验证时间：2025年7月12日*
*状态：已修正，待测试*
