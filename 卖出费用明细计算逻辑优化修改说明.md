# 卖出费用明细计算逻辑优化修改说明

## 修改概述
本次修改优化了卖出记录页面的费用计算逻辑，主要包括：
1. 将"佣金"名称变更为"经纪佣金"
2. 修改经纪佣金计算方式：按卖出金额0.15%计算，与75元取较高值
3. 修改印花税计算精度：改为向上取整到整数
4. 确保所有相关界面显示一致

## 修改内容

### 1. 经纪佣金计算优化
- **原计算方式**：固定75元
- **新计算方式**：卖出股数 × 卖出价格 × 0.15%，与75元取较高值
- **取值规则**：`Math.max(计算金额, 75.00)`
- **精度处理**：保留两位小数并四舍五入

### 2. 印花税计算精度调整
- **原计算方式**：卖出金额 × 0.1%，四舍五入保留两位小数
- **新计算方式**：卖出金额 × 0.1%，向上取整到整数
- **精度处理**：使用`Math.ceil()`向上取整
- **示例**：
  - 计算结果3.67 → 显示4.00
  - 计算结果3.15 → 显示4.00
  - 计算结果3.00 → 显示3.00

### 3. 完整卖出费用列表
更新后的卖出费用明细：

| 费用项目 | 计算方式 | 精度处理 |
|----------|----------|----------|
| 经纪佣金 | max(卖出金额 × 0.15%, 75元) | 保留两位小数 |
| 印花税 | 卖出金额 × 0.1% | 向上取整到整数 |
| 交易徵费 | 卖出金额 × 0.00285% | 保留两位小数 |
| 交易费 | 卖出金额 × 0.00565% | 保留两位小数 |
| 结算费 | max(卖出金额 × 0.002%, 3元) | 保留两位小数 |

**总费用** = 经纪佣金 + 印花税 + 交易徵费 + 交易费 + 结算费

## 修改文件

### 1. JavaScript文件修改
**文件**: `pages/sell-record/sell-record.js`

#### 数据结构更新
```javascript
feeDetails: {
  commission: '75.00',        // 经纪佣金
  stampDuty: '0.00',          // 印花税
  tradingLevy: '0.00',        // 交易徵费
  tradingFee: '0.00',         // 交易费
  settlementFee: '0.00',      // 结算费
  totalFee: '0.00'            // 总费用
}
```

#### 费用计算逻辑更新
```javascript
calculateSellFees(sellShares, sellPrice) {
  const baseAmount = sellShares * sellPrice
  
  // 经纪佣金：卖出金额 * 0.15%，与75元取较高值
  const calculatedCommission = Math.round(baseAmount * 0.0015 * 100) / 100  // 0.15%
  const commission = Math.max(calculatedCommission, 75.00)  // 与75元取较高值
  
  // 印花税：卖出金额 * 0.1%，向上取整到整数
  const calculatedStampDuty = baseAmount * 0.001  // 0.1%
  const stampDuty = Math.ceil(calculatedStampDuty)  // 向上取整
  
  const tradingLevy = Math.round(baseAmount * 0.0000285 * 100) / 100  // 交易徵费 0.00285%
  const tradingFee = Math.round(baseAmount * 0.0000565 * 100) / 100  // 交易费 0.00565%
  
  // 结算费 0.002%，最低3元
  let settlementFee = Math.round(baseAmount * 0.00002 * 100) / 100  // 0.002%
  if (settlementFee < 3.00) {
    settlementFee = 3.00
  }
  
  // 总费用 = 印花税 + 交易徵费 + 交易费 + 结算费 + 经纪佣金
  const totalFee = Math.round((stampDuty + tradingLevy + tradingFee + settlementFee + commission) * 100) / 100
  
  return {
    commission: commission.toFixed(2),
    stampDuty: stampDuty.toFixed(2),
    tradingLevy: tradingLevy.toFixed(2),
    tradingFee: tradingFee.toFixed(2),
    settlementFee: settlementFee.toFixed(2),
    totalFee: totalFee.toFixed(2)
  }
}
```

### 2. WXML文件修改
**文件**: `pages/sell-record/sell-record.wxml`

#### 费用明细显示更新
```wxml
<view class="fee-details">
  <view class="fee-title">卖出费用明细</view>
  <view class="fee-item">
    <text class="fee-label">经纪佣金 (0.15%，最低¥75)：</text>
    <text class="fee-value">¥{{feeDetails.commission}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">印花税 (0.1%，向上取整)：</text>
    <text class="fee-value">¥{{feeDetails.stampDuty}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易徵费 (0.00285%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易费 (0.00565%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingFee}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">结算费 (0.002%，最低¥3)：</text>
    <text class="fee-value">¥{{feeDetails.settlementFee}}</text>
  </view>
  <view class="fee-total">
    <text class="fee-total-label">总费用：</text>
    <text class="fee-total-value">¥{{feeDetails.totalFee}}</text>
  </view>
</view>
```

### 3. 编辑页面更新
**文件**: `pages/add-stock/add-stock.wxml`

#### 卖出费用明细显示
```wxml
<view class="fee-details" wx:if="{{formData.sellFeeDetails}}">
  <view class="fee-title">卖出费用明细</view>
  <view class="fee-item">
    <text class="fee-label">经纪佣金：</text>
    <text class="fee-value">¥{{formData.sellFeeDetails.commission}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">印花税：</text>
    <text class="fee-value">¥{{formData.sellFeeDetails.stampDuty}}</text>
  </view>
  <!-- 其他费用项目保持不变 -->
</view>
```

## 计算示例

### 示例1：高价值交易
假设卖出信息：
- 卖出股数：1000股
- 卖出价格：¥50.00
- 卖出金额：1000 × 50 = ¥50,000

费用计算：
1. **经纪佣金**：
   - 计算值：50,000 × 0.15% = ¥75.00
   - 与75元比较：max(75.00, 75.00) = **¥75.00**

2. **印花税**：
   - 计算值：50,000 × 0.1% = 50.00
   - 向上取整：Math.ceil(50.00) = **¥50.00**

**总费用**：¥75.00 + ¥50.00 + 其他费用

### 示例2：高价值交易（经纪佣金超过最低值）
假设卖出信息：
- 卖出股数：1000股  
- 卖出价格：¥100.00
- 卖出金额：1000 × 100 = ¥100,000

费用计算：
1. **经纪佣金**：
   - 计算值：100,000 × 0.15% = ¥150.00
   - 与75元比较：max(150.00, 75.00) = **¥150.00**

2. **印花税**：
   - 计算值：100,000 × 0.1% = 100.00
   - 向上取整：Math.ceil(100.00) = **¥100.00**

### 示例3：印花税向上取整示例
假设卖出金额：¥3,670

1. **印花税**：
   - 计算值：3,670 × 0.1% = 3.67
   - 向上取整：Math.ceil(3.67) = **¥4.00**

假设卖出金额：¥3,150
1. **印花税**：
   - 计算值：3,150 × 0.1% = 3.15
   - 向上取整：Math.ceil(3.15) = **¥4.00**

## 影响对比

### 经纪佣金变化
| 卖出金额 | 原佣金 | 新佣金(0.15%) | 实际佣金 |
|----------|--------|--------------|----------|
| ¥10,000 | ¥75.00 | ¥15.00 | ¥75.00 |
| ¥50,000 | ¥75.00 | ¥75.00 | ¥75.00 |
| ¥100,000 | ¥75.00 | ¥150.00 | ¥150.00 |
| ¥200,000 | ¥75.00 | ¥300.00 | ¥300.00 |

### 印花税变化示例
| 卖出金额 | 原印花税 | 新印花税 | 差额 |
|----------|----------|----------|------|
| ¥10,000 | ¥10.00 | ¥10.00 | ¥0.00 |
| ¥10,150 | ¥10.15 | ¥11.00 | +¥0.85 |
| ¥10,670 | ¥10.67 | ¥11.00 | +¥0.33 |

## 测试建议

### 1. 经纪佣金测试
- [ ] 小额交易（如¥10,000），验证经纪佣金为¥75.00
- [ ] 临界值交易（如¥50,000），验证经纪佣金为¥75.00
- [ ] 大额交易（如¥100,000），验证经纪佣金为¥150.00

### 2. 印花税测试
- [ ] 整数金额（如¥10,000），验证印花税为¥10.00
- [ ] 小数金额（如¥10,150），验证印花税为¥11.00
- [ ] 小数金额（如¥10,670），验证印花税为¥11.00

### 3. 界面一致性测试
- [ ] 卖出记录页面费用名称显示正确
- [ ] 编辑页面费用名称显示正确
- [ ] 费用计算结果在各页面显示一致

## 数据兼容性

### 向后兼容
- 已有的卖出记录数据结构保持不变
- 新的计算逻辑应用于新创建的卖出记录
- 编辑现有记录时会使用新的计算逻辑重新计算

### 业务逻辑
- 经纪佣金计算更符合实际业务规则（按比例收取，设置最低限额）
- 印花税向上取整符合税务规定（通常税收以整数计算）

## 完成时间
2025年7月14日

## 注意事项
1. **经纪佣金变化**：高价值交易的经纪佣金可能显著增加
2. **印花税精度**：向上取整可能导致印花税小幅增加
3. **总费用影响**：修改后的计算方式可能影响整体盈利计算
4. **界面更新**：确保所有显示经纪佣金的地方都使用新名称
