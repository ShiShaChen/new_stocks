# 中签卖出手续费与总资金负数显示修复说明

## 修复内容

### 1. 手续费独立记录功能
✅ **中签时手续费独立记录**
- 中签申购金额使用 `allot` 类型记录
- 中签手续费使用 `fee_deduction` 类型单独记录
- 修改中签时先回滚旧费用（`allot_refund`、`fee_refund`），再记录新费用
- 手续费在资金流水中清楚标识为"中签手续费"

✅ **卖出时手续费独立记录**
- 卖出收入使用 `sell` 类型记录
- 卖出手续费使用 `fee_deduction` 类型单独记录
- 修改卖出时先回滚旧费用（`sell_refund`、`fee_refund`），再记录新费用
- 手续费在资金流水中清楚标识为"卖出手续费"

### 2. 总资金负数显示修复
✅ **formatter.wxs 负数显示修复**
- 修复了 `formatAmount` 函数使用 `Math.abs()` 取绝对值的问题
- 现在支持负数余额正确显示，如：`-HK$1,234.56`
- 保持了原有的千位分隔符和两位小数格式

✅ **资金流水显示优化**
- 更新了 `fund-detail.js` 中的业务类型标签映射
- 新增了费用相关类型的图标和颜色样式
- 手续费扣除显示红色（负向），手续费退款显示绿色（正向）

## 涉及的文件

### 核心逻辑文件
1. `/pages/winning-result/winning-result.js` - 中签结果保存逻辑
2. `/pages/sell-record/sell-record.js` - 卖出记录保存逻辑
3. `/utils/fundManager.js` - 资金管理器，支持新的费用类型

### 显示相关文件
4. `/utils/formatter.wxs` - 金额格式化，支持负数显示
5. `/pages/fund-detail/fund-detail.js` - 资金流水显示，支持新费用类型
6. `/pages/profile/profile.wxml` - 个人页面总资金显示
7. `/pages/fund-management/fund-management.wxml` - 资金管理页面余额显示

## 新增的交易类型

| 类型 | 说明 | 资金影响 | 显示标识 |
|------|------|----------|----------|
| `fee_deduction` | 手续费扣除 | 减少余额 | 💸 手续费扣除 |
| `fee_refund` | 手续费退款 | 增加余额 | 💰 手续费退款 |
| `allot_refund` | 中签退款 | 增加余额 | ↩️ 中签退款 |
| `sell_refund` | 卖出退款 | 减少余额 | 📉 卖出退款 |

## 资金流水示例

### 中签场景
1. 中签申购: `中签申购金额 腾讯控股 1000股` (type: allot)
2. 中签手续费: `中签手续费 腾讯控股 1000股` (type: fee_deduction)

### 卖出场景
1. 卖出收入: `卖出收入 腾讯控股 1000股 @350.00` (type: sell)
2. 卖出手续费: `卖出手续费 腾讯控股 1000股` (type: fee_deduction)

### 修改操作
修改中签或卖出时，系统会：
1. 先回滚之前的申购金额/收入和手续费
2. 再记录新的申购金额/收入和手续费

## 精度处理

✅ **四舍五入处理**
- 所有金额计算都使用 `Math.round(amount * 100) / 100` 确保两位小数
- 账户余额支持负数显示
- 资金流水记录保持精确的金额记录

## 测试建议

### 基础功能测试
1. **中签测试**
   - 新增中签，检查申购金额和手续费是否分别记录
   - 修改中签数量，检查旧费用回滚和新费用记录
   - 检查账户余额变化是否正确

2. **卖出测试**
   - 新增卖出，检查卖出收入和手续费是否分别记录
   - 修改卖出价格/数量，检查旧费用回滚和新费用记录
   - 检查账户余额变化是否正确

### 负数显示测试
3. **负数余额测试**
   - 创建余额不足的账户
   - 进行大额申购，使余额变为负数
   - 检查各个页面（个人页面、资金管理、资金流水）是否正确显示负数

### 边界情况测试
4. **边界测试**
   - 测试极大金额的精度处理
   - 测试频繁修改中签/卖出的情况
   - 测试手续费为0的情况

## 注意事项

1. **兼容性**: 新的费用类型向下兼容，不影响现有数据
2. **数据完整性**: 修改操作使用回滚机制，确保数据一致性
3. **用户体验**: 负数余额用红色显示，提醒用户注意资金状况
4. **审计追踪**: 所有费用变动都有详细的流水记录，便于后续审计
