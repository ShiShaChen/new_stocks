# 新增打新页面字段调整功能说明

## 功能概述
根据用户需求，对新增打新页面进行了重大调整，简化了录入流程，去除了不必要的字段，并新增了打新方法选项。

## 主要变更

### 1. 去除的字段
- **额外成本** - 移除了额外成本输入项
- **是否融资** - 移除了融资开关选项
- **投入总金额** - 移除了总金额输入项

### 2. 修改的字段
- **打新成本价** → **股票发行价** - 更准确地反映股票的发行价格
- **新增打新套餐费用** - 独立的套餐费用字段

### 3. 新增的字段
- **打新方法** - 新增单选项，包含以下选项：
  - 现金
  - 90孖展

## 技术实现

### 1. 数据结构调整

#### 原数据结构
```javascript
formData: {
  stockName: '',
  costPrice: '',           // 已移除
  subscriptionHands: '',
  serviceFee: '0',
  extraCost: '0',          // 已移除
  isFinancing: false,      // 已移除
  totalAmount: '',         // 已移除
  status: 'ongoing',
  // 其他字段...
}
```

#### 新数据结构
```javascript
formData: {
  stockName: '',
  issuePrice: '',              // 新增：股票发行价
  packageFee: '',              // 新增：打新套餐费用
  subscriptionHands: '',
  serviceFee: '0',
  subscriptionMethod: 'cash',  // 新增：打新方法
  status: 'ongoing',
  // 其他字段...
}
```

### 2. 界面布局调整

#### WXML结构
```xml
<!-- 股票发行价 -->
<view class="form-item">
  <text class="form-label">股票发行价 *</text>
  <input class="form-input" name="issuePrice" type="digit" 
         placeholder="请输入发行价" value="{{formData.issuePrice}}" 
         disabled="{{readonly}}" />
</view>

<!-- 打新套餐费用 -->
<view class="form-item">
  <text class="form-label">打新套餐费用 *</text>
  <input class="form-input" name="packageFee" type="digit" 
         placeholder="请输入套餐费用" value="{{formData.packageFee}}" 
         disabled="{{readonly}}" />
</view>

<!-- 打新方法 -->
<view class="form-item">
  <text class="form-label">打新方法 *</text>
  <radio-group name="subscriptionMethod" bindchange="onSubscriptionMethodChange">
    <label class="radio-item">
      <radio value="cash" checked="{{formData.subscriptionMethod === 'cash'}}" 
             disabled="{{readonly}}" />
      <text>现金</text>
    </label>
    <label class="radio-item">
      <radio value="margin90" checked="{{formData.subscriptionMethod === 'margin90'}}" 
             disabled="{{readonly}}" />
      <text>90孖展</text>
    </label>
  </radio-group>
</view>
```

### 3. 表单验证更新

#### 必填字段验证
```javascript
// 验证必填字段
if (!formData.stockName || !formData.issuePrice || !formData.packageFee || 
    !formData.subscriptionHands || !formData.subscriptionMethod) {
  wx.showToast({
    title: '请填写必填字段',
    icon: 'none'
  })
  return
}
```

#### 数据处理
```javascript
const stockData = {
  id: this.data.stockId || this.generateId(),
  stockName: formData.stockName.trim(),
  issuePrice: parseFloat(formData.issuePrice),
  packageFee: parseFloat(formData.packageFee),
  subscriptionHands: parseInt(formData.subscriptionHands),
  serviceFee: parseFloat(formData.serviceFee) || 0,
  subscriptionMethod: formData.subscriptionMethod,
  status: formData.status || 'ongoing',
  accountId: accountId,
  createTime: this.data.formData.createTime || Date.now(),
  // 其他字段...
}
```

### 4. 事件处理新增

#### 打新方法变更处理
```javascript
onSubscriptionMethodChange(e) {
  this.setData({
    'formData.subscriptionMethod': e.detail.value
  })
}
```

### 5. 计算逻辑调整

#### 盈亏计算更新
```javascript
calculateProfit(stockData) {
  const sellPrice = stockData.sellPrice
  const sellShares = stockData.sellShares || stockData.winningShares
  const issuePrice = stockData.issuePrice
  const packageFee = stockData.packageFee
  const serviceFee = stockData.serviceFee
  
  if (sellPrice > 0 && sellShares > 0 && issuePrice > 0) {
    // 卖出金额
    const sellAmount = sellPrice * sellShares
    // 成本金额（发行价 * 股数）
    const costAmount = issuePrice * sellShares
    // 总手续费（按比例计算）
    const buyFeeRatio = sellShares / stockData.winningShares
    const totalFees = (packageFee + serviceFee) * buyFeeRatio + sellFee + otherFee
    // 净盈亏（卖出金额 - 成本金额 - 手续费）
    return parseFloat((sellAmount - costAmount - totalFees).toFixed(2))
  }
  return 0
}
```

## 相关页面更新

### 1. 历史记录页面
- 更新显示字段：成本价 → 发行价
- 新增打新方法显示
- 调整套餐费用显示位置
- 更新收益率计算逻辑

#### 显示调整
```xml
<view class="detail-row">
  <text class="detail-label">申购：</text>
  <text class="detail-value">{{item.subscriptionHands}} 手</text>
  <text class="detail-label">发行价：</text>
  <text class="detail-value">¥{{item.issuePrice}}</text>
</view>

<view class="detail-row">
  <text class="detail-label">方法：</text>
  <text class="detail-value">{{item.subscriptionMethod === 'cash' ? '现金' : '90孖展'}}</text>
  <text class="detail-label">套餐费：</text>
  <text class="detail-value">¥{{item.packageFee}}</text>
</view>
```

### 2. 中签结果页面
- 更新中签金额计算：使用issuePrice替代costPrice

```javascript
calculateResult() {
  const winningShares = parseInt(this.data.formData.winningShares) || 0
  const issuePrice = this.data.stockInfo.issuePrice || 0
  
  if (winningShares > 0) {
    // 计算中签金额
    const calculatedAmount = (winningShares * issuePrice).toFixed(2)
    // ...
  }
}
```

### 3. 卖出记录页面
- 更新成本计算和手续费计算
- 使用issuePrice和packageFee替代原有字段

```javascript
// 成本金额计算
const costAmount = issuePrice * sellShares
// 手续费计算
const totalFees = (serviceFee + packageFee) * buyFeeRatio + sellFee + otherFee
```

## 数据兼容性

### 1. 向后兼容处理
- 旧数据中的costPrice字段可以作为issuePrice处理
- extraCost和isFinancing字段在显示时忽略
- totalAmount字段不再使用

### 2. 数据迁移建议
对于已有数据，建议在第一次加载时进行字段映射：
```javascript
// 数据兼容处理示例
if (stock.costPrice && !stock.issuePrice) {
  stock.issuePrice = stock.costPrice
}
if (!stock.subscriptionMethod) {
  stock.subscriptionMethod = 'cash' // 默认现金
}
```

## 用户体验优化

### 1. 界面简化
- 移除不必要的字段，录入更简洁
- 打新方法一目了然
- 字段命名更准确

### 2. 数据准确性
- 发行价与套餐费分离，成本核算更清晰
- 打新方法标识明确，便于后续分析
- 计算逻辑更符合实际业务场景

### 3. 功能完整性
- 保持所有核心功能不变
- 中签和卖出记录功能正常
- 统计和历史记录功能完整

## 测试要点

### 1. 新增记录测试
- [ ] 填写所有必填字段可正常保存
- [ ] 打新方法选择功能正常
- [ ] 数据验证提示准确

### 2. 编辑记录测试
- [ ] 编辑现有记录字段正确显示
- [ ] 修改后保存功能正常
- [ ] 字段更新后计算正确

### 3. 显示和计算测试
- [ ] 历史记录显示字段正确
- [ ] 中签金额计算准确
- [ ] 盈亏计算逻辑正确
- [ ] 收益率计算准确

### 4. 兼容性测试
- [ ] 旧数据正常显示
- [ ] 缺失字段有默认值
- [ ] 不影响现有功能

通过本次调整，新增打新页面更加简洁易用，字段含义更加明确，计算逻辑更符合实际业务需求，为用户提供了更好的使用体验。
