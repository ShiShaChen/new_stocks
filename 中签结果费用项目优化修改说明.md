# 中签结果费用项目优化修改说明

## 修改概述
本次修改优化了中签结果页面的费用计算和显示，主要包括：
1. 新增经纪佣金费用项
2. 更新费用项目名称以符合实际业务
3. 确保数据兼容性

## 修改内容

### 1. 新增经纪佣金
- **费用项目**：经纪佣金
- **计算公式**：中签股数 × 发行价 × 1%
- **显示格式**：保留两位小数并四舍五入

### 2. 费用名称变更
| 原名称 | 新名称 |
|--------|--------|
| 交易费 | 联交所交易费 |
| 交易征费 | 交易所交易会费 |
| 会财局交易征费 | 会财局交易会费 |

### 3. 完整费用列表
更新后的中签费用明细包括：

| 费用项目 | 计算比例 | 计算公式 |
|----------|----------|----------|
| 印花税 | 0.1% | 中签金额 × 0.001 |
| 经纪佣金 | 1% | 中签金额 × 0.01 |
| 联交所交易费 | 0.00565% | 中签金额 × 0.0000565 |
| 交易所交易会费 | 0.0027% | 中签金额 × 0.000027 |
| 会财局交易会费 | 0.00015% | 中签金额 × 0.0000015 |
| 打新套餐费用 | 固定金额 | 用户输入的套餐费 |

**总费用** = 印花税 + 经纪佣金 + 联交所交易费 + 交易所交易会费 + 会财局交易会费 + 打新套餐费用

## 修改文件

### 1. JavaScript文件修改
**文件**: `pages/winning-result/winning-result.js`

#### 数据结构更新
```javascript
feeDetails: {
  stampDuty: '0.00',        // 印花税
  brokerageCommission: '0.00', // 经纪佣金
  tradingFee: '0.00',       // 联交所交易费
  tradingLevy: '0.00',      // 交易所交易会费
  afrcLevy: '0.00',         // 会财局交易会费
  packageFee: '0.00',       // 打新套餐费用
  totalFee: '0.00'          // 总费用
}
```

#### 费用计算逻辑更新
```javascript
calculateFees(winningShares, issuePrice, packageFee) {
  const baseAmount = winningShares * issuePrice
  
  const stampDuty = Math.round(baseAmount * 0.001 * 100) / 100  // 印花税 0.1%
  const brokerageCommission = Math.round(baseAmount * 0.01 * 100) / 100  // 经纪佣金 1%
  const tradingFee = Math.round(baseAmount * 0.0000565 * 100) / 100  // 联交所交易费 0.00565%
  const tradingLevy = Math.round(baseAmount * 0.000027 * 100) / 100  // 交易所交易会费 0.0027%
  const afrcLevy = Math.round(baseAmount * 0.0000015 * 100) / 100  // 会财局交易会费 0.00015%
  
  const totalFee = Math.round((stampDuty + brokerageCommission + tradingFee + tradingLevy + afrcLevy + packageFee) * 100) / 100
  
  return {
    stampDuty: stampDuty.toFixed(2),
    brokerageCommission: brokerageCommission.toFixed(2),
    tradingFee: tradingFee.toFixed(2),
    tradingLevy: tradingLevy.toFixed(2),
    afrcLevy: afrcLevy.toFixed(2),
    packageFee: packageFee.toFixed(2),
    totalFee: totalFee.toFixed(2)
  }
}
```

### 2. WXML文件修改
**文件**: `pages/winning-result/winning-result.wxml`

#### 费用明细显示
```wxml
<view class="fee-details">
  <view class="fee-title">应收费用明细</view>
  <view class="fee-item">
    <text class="fee-label">印花税 (0.1%)：</text>
    <text class="fee-value">¥{{feeDetails.stampDuty}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">经纪佣金 (1%)：</text>
    <text class="fee-value">¥{{feeDetails.brokerageCommission}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">联交所交易费 (0.00565%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingFee}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易所交易会费 (0.0027%)：</text>
    <text class="fee-value">¥{{feeDetails.tradingLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">会财局交易会费 (0.00015%)：</text>
    <text class="fee-value">¥{{feeDetails.afrcLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">打新套餐费用：</text>
    <text class="fee-value">¥{{feeDetails.packageFee}}</text>
  </view>
  <view class="fee-total">
    <text class="fee-total-label">总费用：</text>
    <text class="fee-total-value">¥{{feeDetails.totalFee}}</text>
  </view>
</view>
```

### 3. 编辑页面更新
**文件**: `pages/add-stock/add-stock.wxml`

#### 中签费用明细显示
```wxml
<view class="fee-details" wx:if="{{formData.winningFeeDetails}}">
  <view class="fee-title">中签费用明细</view>
  <view class="fee-item">
    <text class="fee-label">印花税：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.stampDuty}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">经纪佣金：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.brokerageCommission || '0.00'}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">联交所交易费：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.tradingFee}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">交易所交易会费：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.tradingLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">会财局交易会费：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.afrcLevy}}</text>
  </view>
  <view class="fee-item">
    <text class="fee-label">套餐费用：</text>
    <text class="fee-value">¥{{formData.winningFeeDetails.packageFee}}</text>
  </view>
  <view class="fee-total">
    <text class="fee-total-label">总费用：</text>
    <text class="fee-total-value">¥{{formData.winningFeeDetails.totalFee}}</text>
  </view>
</view>
```

## 数据兼容性

### 向后兼容
- 对于已存在的中签记录，如果没有`brokerageCommission`字段，编辑页面会显示"¥0.00"
- 卖出计算仍然使用`winningFeeDetails.totalFee`进行费用计算，确保历史数据正常使用

### 前向兼容
- 新的中签记录会包含所有费用项目，包括经纪佣金
- 所有费用计算都会包含经纪佣金在总费用中

## 计算示例

假设中签信息：
- 中签股数：100股
- 发行价：¥79.00
- 中签金额：100 × 79 = ¥7,900

费用计算：
1. **印花税**：7,900 × 0.1% = ¥7.90
2. **经纪佣金**：7,900 × 1% = ¥79.00
3. **联交所交易费**：7,900 × 0.00565% = ¥0.45
4. **交易所交易会费**：7,900 × 0.0027% = ¥0.21
5. **会财局交易会费**：7,900 × 0.00015% = ¥0.01
6. **打新套餐费用**：¥100.00（假设）

**总费用**：¥7.90 + ¥79.00 + ¥0.45 + ¥0.21 + ¥0.01 + ¥100.00 = **¥187.57**

## 测试建议

### 1. 功能测试
- [ ] 新建中签记录，验证经纪佣金计算正确
- [ ] 验证费用名称显示正确
- [ ] 验证总费用计算包含经纪佣金

### 2. 兼容性测试
- [ ] 编辑已有的中签记录，确保经纪佣金显示为0.00
- [ ] 验证卖出计算仍然正常使用总费用

### 3. 数据一致性测试
- [ ] 验证中签页面和编辑页面费用明细显示一致
- [ ] 验证费用计算结果四舍五入正确

## 注意事项

1. **费用精度**：所有费用计算都使用`Math.round()`进行四舍五入，确保金额精度
2. **名称统一**：确保所有显示费用名称的地方都使用新的名称
3. **总费用计算**：经纪佣金已加入总费用计算，会影响整体成本
4. **向后兼容**：旧数据中没有经纪佣金字段时，使用默认值0.00显示

## 完成时间
2025年7月14日
