# 资金详情页"未知类型"流水时间显示修复说明

## 修复时间
2025年7月16日

## 问题描述
用户反馈资金详情页中，流水类型为'未知类型'时，显示的具体时间都是整时（如14:00，10:00），希望显示真正的操作时间而不是业务时间。

## 根本原因分析

### 1. 业务类型映射不完整
在`getBusinessTypeLabel`函数中缺少对某些业务类型的映射，导致显示为原始类型值，被用户理解为"未知类型"。

### 2. 时间显示逻辑混乱
资金详情页面在显示时间时，优先显示`businessDateTime`（业务时间），其次显示`formattedDateTime`（实际操作时间）。对于中签等业务操作：
- `businessDate`使用了固定时间（如10:00），这是业务发生的逻辑时间
- `datetime`是实际用户操作的时间，包含精确的时分秒

### 3. 用户期望与实际显示不符
用户希望看到真实的操作时间（即他们实际录入数据的时间），而不是业务逻辑时间。

## 修复内容

### 1. 扩展业务类型映射 (`pages/fund-detail/fund-detail.js`)

```javascript
// 获取业务类型标签
getBusinessTypeLabel(type) {
  const typeMap = {
    'subscribe': '打新申购',
    'allot': '中签扣款',
    'allot_refund': '中签退款',
    'fee_deduction': '手续费扣除',
    'fee_refund': '手续费退款',
    'sell': '卖出收入',
    'sell_refund': '卖出退款',
    // 添加资金相关的业务类型
    'deposit': '资金转入',
    'withdraw': '资金转出'
  }
  return typeMap[type] || type
}
```

### 2. 优化时间显示逻辑 (`pages/fund-detail/fund-detail.js`)

```javascript
// 如果业务类型被识别且有业务日期，优先显示业务日期；否则显示实际操作时间
businessDateTime: record.businessDate && businessRecord.displayType !== record.type 
  ? this.formatBusinessDateTime(record.businessDate) 
  : null
```

**修改逻辑：**
- 如果业务类型能被正确识别（`displayType !== record.type`）且有业务日期，显示业务时间
- 如果业务类型无法识别或没有业务日期，优先显示实际操作时间

### 3. 添加双时间显示功能 (`pages/fund-detail/fund-detail.wxml`)

```xml
<view class="record-meta">
  <text class="datetime-text">{{item.businessDateTime || item.formattedDateTime}}</text>
  <!-- 如果有业务时间且与实际操作时间不同，显示实际操作时间作为副时间 -->
  <text class="operation-time" wx:if="{{item.businessDateTime && item.businessDateTime !== item.formattedDateTime}}">
    实际操作：{{item.formattedDateTime}}
  </text>
  <view class="status-badge {{item.status}}">
    <text class="status-text">{{item.status === 'pending' ? '处理中' : item.status === 'completed' ? '已完成' : '失败'}}</text>
  </view>
</view>
```

**新增功能：**
- 当业务时间和实际操作时间不同时，同时显示两个时间
- 主时间显示业务相关时间（如中签日期10:00）
- 副时间显示实际操作时间（如用户录入时间14:23）

### 4. 样式优化 (`pages/fund-detail/fund-detail.wxss`)

```css
.record-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8rpx;
}

.operation-time {
  font-size: 20rpx;
  color: #95a5a6;
  font-weight: 400;
  font-style: italic;
}

.status-badge {
  align-self: flex-end;
}
```

### 5. 添加调试信息 (`utils/fundManager.js`)

```javascript
// 添加业务交易记录
addBusinessTransaction(transaction) {
  // 调试：输出传入的datetime信息
  console.log('添加业务交易记录 - 原始datetime:', transaction.datetime)
  console.log('添加业务交易记录 - 解析时间戳:', new Date(transaction.datetime).getTime())
  console.log('添加业务交易记录 - 格式化时间:', new Date(transaction.datetime).toLocaleString())
  
  // ...其余代码
}
```

## 用户体验改进

### Before（修复前）
- 部分记录显示为"未知类型"
- 时间显示为固定整时（10:00, 14:00）
- 用户无法知道真实操作时间

### After（修复后）
- 所有业务类型都有清晰的中文标签
- "未知类型"记录优先显示实际操作时间
- 已知业务类型同时显示业务时间和实际操作时间
- 时间信息更加透明和完整

## 技术细节

### 时间字段说明
1. **`datetime`**: 用户实际操作时间（ISO字符串格式）
2. **`businessDate`**: 业务逻辑时间（如中签日期，ISO字符串格式）
3. **`timestamp`**: `datetime`转换的时间戳（数字）
4. **`createTime`**: 记录创建时间戳（数字）

### 显示优先级
1. 已知业务类型 + 有业务日期 → 显示业务时间 + 实际操作时间
2. 已知业务类型 + 无业务日期 → 显示实际操作时间
3. 未知业务类型 → 显示实际操作时间

## 测试建议

1. **新增各类业务交易**：验证所有业务类型都有正确的中文标签
2. **时间显示测试**：确认业务时间和实际操作时间都能正确显示
3. **历史数据兼容性**：验证现有数据在新逻辑下正常显示
4. **调试信息验证**：通过控制台查看时间戳生成是否正确

## 相关文件
- `/pages/fund-detail/fund-detail.js` - 业务逻辑和时间显示逻辑
- `/pages/fund-detail/fund-detail.wxml` - 时间显示模板
- `/pages/fund-detail/fund-detail.wxss` - 时间显示样式
- `/utils/fundManager.js` - 业务交易记录管理和调试信息
