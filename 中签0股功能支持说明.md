# 中签0股功能支持说明

## 修正时间
2025年7月16日

## 功能需求
1. 支持录入中签0股的情况（打新未中签）
2. 进入卖出页面时直接显示中签股数
3. 当中签股数为0时，只允许点击"结束打新"，不允许保存卖出记录
4. 中签股数为0时，不需要校验卖出价格
5. 中签股数为0时，卖出不产生任何费用

## 技术实现

### 1. 页面显示优化
- 在卖出记录页面直接显示中签股数
- 页面加载时将中签股数自动填入卖出股数字段

### 2. 按钮状态控制
**修改前：**
```wxml
<view bindtap="onSaveSellRecord" class="btn-primary {{!formData.sellPrice ? 'btn-disabled' : ''}}">
```

**修改后：**
```wxml
<view bindtap="onSaveSellRecord" class="btn-primary {{(stockInfo.winningShares === 0 || !formData.sellPrice) ? 'btn-disabled' : ''}}">
```

### 3. 保存卖出记录逻辑
在`onSaveSellRecord`方法开头添加中签股数检查：
```javascript
// 如果中签股数为0，不允许保存卖出记录
if (this.data.stockInfo.winningShares === 0) {
  wx.showToast({
    title: '中签股数为0，无法保存卖出记录',
    icon: 'none'
  })
  return
}
```

### 4. 结束打新逻辑优化
修改`finishStock`方法，支持两种模式：
- **中签股数 > 0**：需要验证卖出价格，保存卖出记录后结束
- **中签股数 = 0**：不需要验证价格，直接结束打新

```javascript
finishStock() {
  // 如果中签股数为0，不需要验证卖出价格
  if (this.data.stockInfo.winningShares === 0) {
    wx.showModal({
      title: '确认操作',
      content: '确定要结束这只股票的打新吗？中签股数为0，将直接结束打新状态。',
      success: (res) => {
        if (res.confirm) {
          this.finishStockWithoutSell()
        }
      }
    })
    return
  }
  // ...existing code for winningShares > 0
}
```

### 5. 新增方法：finishStockWithoutSell
专门处理中签股数为0的结束打新操作：
```javascript
finishStockWithoutSell() {
  console.log('结束打新（中签股数为0）')
  
  let stocks = wx.getStorageSync('stocks') || []
  const stockIndex = stocks.findIndex(item => item.id === this.data.stockId)
  
  if (stockIndex !== -1) {
    // 直接更新状态为打新结束，不需要保存卖出记录
    stocks[stockIndex].status = 'finished'
    wx.setStorageSync('stocks', stocks)
    
    wx.showToast({
      title: '打新结束',
      icon: 'success'
    })
    setTimeout(() => {
      wx.navigateBack()
    }, 1500)
  }
}
```

### 6. 盈亏计算优化
在`calculateProfit`方法开头添加中签股数为0的处理：
```javascript
// 当中签股数为0时，直接设置为0值
if (this.data.stockInfo.winningShares === 0) {
  this.setData({
    sellAmount: '0.00',
    costAmount: '0.00',
    totalFees: '0.00',
    profit: 0,
    profitRate: 0,
    feeDetails: {
      commission: '0.00',
      stampDuty: '0.00',
      tradingLevy: '0.00',
      tradingFee: '0.00',
      settlementFee: '0.00',
      totalFee: '0.00'
    }
  })
  return
}
```

## 文件修改列表
1. **pages/sell-record/sell-record.js**：
   - 修改 `onSaveSellRecord` 方法，添加中签股数检查
   - 修改 `finishStock` 方法，支持中签股数为0的情况
   - 新增 `finishStockWithoutSell` 方法
   - 修改 `calculateProfit` 方法，处理中签股数为0的情况

2. **pages/sell-record/sell-record.wxml**：
   - 修改保存按钮的禁用条件，当中签股数为0时禁用

## 业务流程
### 中签股数 > 0 的流程
1. 进入页面 → 显示中签股数
2. 输入卖出价格 → 计算盈亏和费用
3. 点击"保存卖出记录" → 保存数据
4. 点击"结束打新" → 验证价格 → 保存记录 → 更新状态

### 中签股数 = 0 的流程  
1. 进入页面 → 显示中签股数为0
2. "保存卖出记录"按钮禁用
3. 盈亏和费用显示为0
4. 点击"结束打新" → 直接更新状态（无需验证价格）

## 用户体验优化
1. **清晰的状态提示**：中签股数为0时，按钮状态和提示信息都明确指导用户操作
2. **合理的验证逻辑**：避免无效操作，如中签0股时还要求输入卖出价格
3. **简化的操作流程**：中签0股时直接结束打新，无需复杂的卖出记录流程

## 测试建议
1. 测试中签股数为0的新增股票
2. 测试中签股数大于0的正常流程
3. 验证按钮禁用状态正确
4. 确认费用计算在中签股数为0时正确显示为0
5. 测试结束打新功能在两种情况下都能正常工作
