# 账户余额与资金流水集成功能实现说明

## 功能概述
本次实现将中签操作和卖出操作与账户余额管理系统集成，实现以下核心功能：
1. 中签时自动扣除费用并影响账户余额
2. 卖出时自动增加收入并影响账户余额
3. 修改中签数量或卖出价格时同步更新余额和费用明细
4. 所有资金变动记录在资金流水中
5. 支持负数余额，所有金额保留两位小数并四舍五入

## 实现架构

### 1. 核心组件
- **FundManager**: 资金管理工具类，处理账户余额和资金流水
- **BusinessTransaction**: 业务交易记录，记录所有资金变动
- **AccountFunds**: 账户资金状态，实时反映余额情况

### 2. 交易类型定义
| 交易类型 | 说明 | 余额影响 |
|----------|------|----------|
| allot | 中签扣费 | 减少余额 |
| allot_refund | 中签费用回滚 | 增加余额 |
| sell | 卖出收入 | 增加余额 |
| sell_refund | 卖出收入回滚 | 减少余额 |

## 实现细节

### 1. 中签结果页面 (winning-result.js)

#### 引入资金管理器
```javascript
const FundManager = require('../../utils/fundManager.js')

Page({
  data: {
    // ...existing data...
    fundManager: null
  },

  onLoad(options) {
    // 初始化资金管理器
    this.setData({
      fundManager: new FundManager()
    })
    // ...existing code...
  }
})
```

#### 保存中签结果时的资金处理
```javascript
saveWinningResult(winningData) {
  // ...existing code...
  
  // 计算中签金额和费用
  const winningAmount = Math.round(winningData.winningShares * oldStock.issuePrice * 100) / 100
  const totalFees = parseFloat(winningData.winningFeeDetails.totalFee)
  const totalCost = Math.round((winningAmount + totalFees) * 100) / 100
  
  // 检查是否为修改操作
  const isModification = oldStock.winningShares > 0
  
  if (this.data.fundManager && oldStock.accountId) {
    if (isModification) {
      // 修改操作：先回滚原费用，再扣除新费用
      const oldTotalCost = calculateOldTotalCost()
      
      // 回滚原费用
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'allot_refund',
        amount: oldTotalCost,
        description: '修改中签结果-回滚原费用'
      })
      
      // 扣除新费用
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'allot',
        amount: winningAmount,
        fees: totalFees,
        description: '中签扣费'
      })
    } else {
      // 新增操作：直接扣除费用
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'allot',
        amount: winningAmount,
        fees: totalFees,
        description: '中签扣费'
      })
    }
  }
  
  // ...save stock data...
}
```

### 2. 卖出记录页面 (sell-record.js)

#### 引入资金管理器
```javascript
const FundManager = require('../../utils/fundManager.js')

Page({
  data: {
    // ...existing data...
    fundManager: null
  },

  onLoad(options) {
    // 初始化资金管理器
    this.setData({
      fundManager: new FundManager()
    })
    // ...existing code...
  }
})
```

#### 保存卖出记录时的资金处理
```javascript
saveSellRecord(sellData) {
  // ...existing code...
  
  // 计算卖出收入和费用
  const sellAmount = Math.round(sellData.sellShares * sellData.sellPrice * 100) / 100
  const totalFees = parseFloat(sellData.feeDetails.totalFee)
  const netReceived = Math.round((sellAmount - totalFees) * 100) / 100
  const profitLoss = Math.round(sellData.profit * 100) / 100
  
  // 检查是否为修改操作
  const isModification = oldStock.sellShares > 0
  
  if (this.data.fundManager && oldStock.accountId) {
    if (isModification) {
      // 修改操作：先回滚原收入，再记录新收入
      const oldNetReceived = calculateOldNetReceived()
      const oldProfitLoss = calculateOldProfitLoss()
      
      // 回滚原收入
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'sell_refund',
        amount: -oldNetReceived,
        profitLoss: -oldProfitLoss,
        description: '修改卖出记录-回滚原收入'
      })
      
      // 记录新收入
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'sell',
        amount: netReceived,
        profitLoss: profitLoss,
        description: '卖出收入'
      })
    } else {
      // 新增操作：直接记录收入
      this.data.fundManager.addBusinessTransaction({
        accountId: oldStock.accountId,
        type: 'sell',
        amount: netReceived,
        profitLoss: profitLoss,
        description: '卖出收入'
      })
    }
  }
  
  // ...save stock data...
}
```

### 3. 资金管理器更新 (fundManager.js)

#### 新增交易类型处理
```javascript
updateAccountFunds(accountId) {
  // ...existing code...
  
  // 处理业务交易影响
  businessTransactions.forEach(transaction => {
    const amount = transaction.amount || 0
    const fees = transaction.fees || 0
    const profitLoss = transaction.profitLoss || 0
    
    if (transaction.type === 'allot') {
      // 中签扣款
      funds.balances.HKD -= amount
      funds.balances.HKD -= fees
    } else if (transaction.type === 'allot_refund') {
      // 中签费用回滚
      funds.balances.HKD += amount
      funds.balances.HKD += fees
    } else if (transaction.type === 'sell') {
      // 卖出收入
      funds.balances.HKD += amount
      funds.balances.HKD += profitLoss
      funds.balances.HKD -= fees
    } else if (transaction.type === 'sell_refund') {
      // 卖出收入回滚
      funds.balances.HKD -= amount
      funds.balances.HKD -= profitLoss
      funds.balances.HKD += fees
    }
  })

  // 四舍五入到两位小数
  funds.balances.HKD = Math.round(funds.balances.HKD * 100) / 100
  
  // ...save funds...
}
```

## 资金流水记录格式

### 中签扣费记录
```javascript
{
  id: 'transaction_id',
  accountId: 'account_id',
  type: 'allot',
  stockId: 'stock_id',
  stockName: '股票名称',
  amount: 7900.00,        // 中签金额
  fees: 179.67,           // 总费用
  profitLoss: 0,
  description: '中签扣费 股票名称 100股',
  datetime: '2025-07-14T12:00:00.000Z',
  createTime: 1642176000000,
  timestamp: 1642176000000
}
```

### 卖出收入记录
```javascript
{
  id: 'transaction_id',
  accountId: 'account_id',
  type: 'sell',
  stockId: 'stock_id',
  stockName: '股票名称',
  amount: 8500.00,        // 净收入（卖出金额-费用）
  fees: 0,                // 费用已从金额中扣除
  profitLoss: 420.33,     // 盈亏金额
  description: '卖出收入 股票名称 100股 @85.00',
  datetime: '2025-07-14T12:00:00.000Z',
  createTime: 1642176000000,
  timestamp: 1642176000000
}
```

### 回滚操作记录
```javascript
{
  id: 'transaction_id',
  accountId: 'account_id',
  type: 'allot_refund',
  stockId: 'stock_id',
  stockName: '股票名称',
  amount: 8079.67,        // 回滚金额
  fees: 0,
  profitLoss: 0,
  description: '修改中签结果-回滚原费用 股票名称',
  datetime: '2025-07-14T12:00:00.000Z',
  createTime: 1642176000000,
  timestamp: 1642176000000
}
```

## 余额计算示例

### 初始状态
- 账户余额：¥10,000.00

### 中签操作
- 中签金额：¥7,900.00
- 中签费用：¥179.67
- 扣除总额：¥8,079.67
- **余额变为**：¥10,000.00 - ¥8,079.67 = **¥1,920.33**

### 卖出操作
- 卖出金额：¥8,500.00
- 卖出费用：¥165.00
- 净收入：¥8,335.00
- **余额变为**：¥1,920.33 + ¥8,335.00 = **¥10,255.33**

### 修改中签数量
- 原中签：100股，费用¥179.67
- 新中签：150股，费用¥269.51
- 回滚：+¥8,079.67
- 新扣除：-¥12,169.51
- **余额变化**：¥10,255.33 + ¥8,079.67 - ¥12,169.51 = **¥6,165.49**

## 精度处理

### 1. 金额计算精度
```javascript
// 所有金额计算都使用四舍五入到两位小数
const amount = Math.round(shares * price * 100) / 100
const totalFees = Math.round(fees * 100) / 100
const balance = Math.round(balance * 100) / 100
```

### 2. 负数余额支持
- 系统允许账户余额为负数
- 负数余额正常显示和计算
- 不对负数余额进行限制或警告

### 3. 数据一致性
- 所有资金变动都通过FundManager处理
- 确保余额计算的一致性和准确性
- 支持修改操作的回滚和重新计算

## 测试建议

### 1. 基础功能测试
- [ ] 中签时余额正确扣除
- [ ] 卖出时余额正确增加
- [ ] 资金流水记录完整

### 2. 修改操作测试
- [ ] 修改中签数量时余额同步更新
- [ ] 修改卖出价格时余额同步更新
- [ ] 回滚操作正确执行

### 3. 精度测试
- [ ] 金额计算保留两位小数
- [ ] 四舍五入处理正确
- [ ] 负数余额正常处理

### 4. 边界情况测试
- [ ] 账户余额为负数时的操作
- [ ] 大金额交易的精度处理
- [ ] 频繁修改操作的数据一致性

## 注意事项

1. **数据安全**: 所有资金操作都有完整的审计记录
2. **事务性**: 如果资金流水处理失败，会显示警告但不阻止数据保存
3. **向后兼容**: 对于没有accountId的旧股票记录，不进行资金处理
4. **错误处理**: 资金处理失败时给出明确的错误提示
5. **性能考虑**: 每次操作都会重新计算账户余额，确保数据准确性

## 完成时间
2025年7月14日
