# 卖出盈亏重复计算问题修复说明

## 问题描述

用户报告了一个严重的计算错误：
- 海天味业，发行价36.3，中签100股，中签费用124.62
- 按36.7卖出100股，卖出手续费82.31
- 预期总盈亏：-166.93，但实际显示：-333.86（翻倍错误）

## 问题根因分析

### 原有错误的逻辑
在sell记录中，profitLoss字段被设置为包含所有费用的净盈亏，但在fundManager中又被加到了余额计算中，导致重复计算。

**错误的资金流水**：
1. 中签：-3630 (申购) - 124.62 (手续费) = -3754.62
2. 卖出：+3670 (收入) + (-166.93) (净盈亏) - 82.31 (手续费) = ?

问题：净盈亏已经包含了所有费用，不应该再次参与余额计算。

## 修复方案

### 简化资金流水逻辑
✅ **sell记录只记录卖出收入**
- 不记录任何盈亏信息
- profitLoss字段设为0
- 只记录实际的收入金额

✅ **费用单独记录**
- 中签手续费通过fee_deduction单独记录
- 卖出手续费通过fee_deduction单独记录

✅ **盈亏计算纯粹用于显示**
- profit字段仍然计算净盈亏供用户查看
- 但不参与资金流水计算

### 修复后的正确计算

**海天味业示例验证**：
1. **中签时（原账户余额0）**：
   - 申购金额：-3630元（allot记录）
   - 中签手续费：-124.62元（fee_deduction记录）
   - 余额：0 - 3630 - 124.62 = -3754.62元

2. **卖出时**：
   - 卖出收入：+3670元（sell记录）
   - 卖出手续费：-82.31元（fee_deduction记录）
   - 余额：-3754.62 + 3670 - 82.31 = -166.93元 ✓

## 修复的文件

### pages/sell-record/sell-record.js
- 移除了sell记录中的profitLoss计算
- 所有sell记录的profitLoss字段设为0
- 保持profit计算用于用户显示

### utils/fundManager.js
- 移除了sell/sell_refund记录中profitLoss的处理
- 简化为只处理卖出金额

## 核心原则

### 资金流水记录原则
1. **一笔记录一个动作**：申购、收入、费用分别记录
2. **不重复计算**：每项费用只记录一次
3. **简单直观**：流水记录直接对应资金变动

### 盈亏计算原则
1. **盈亏用于显示**：给用户看总体收益情况
2. **不参与流水**：盈亏不直接影响资金余额
3. **费用分离**：各项费用在流水中清晰可见

## 验证结果

经过修复，海天味业示例的计算结果：
- 最终余额：-166.93元 ✓
- 符合预期：(36.7-36.3)×100 - 124.62 - 82.31 = 40 - 206.93 = -166.93

这个修复彻底解决了盈亏重复计算的问题，确保资金余额计算的准确性。
