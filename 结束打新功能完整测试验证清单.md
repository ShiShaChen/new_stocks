# 结束打新功能完整测试验证清单

## 测试环境准备

### 前置条件
1. 已有股票记录（包含中签信息）
2. 已配置账户和资金管理
3. 小程序开发工具或真机测试环境

### 测试数据准备
```javascript
// 测试用股票记录
{
  id: 'test_stock_001',
  stockName: '测试股票A',
  issuePrice: 10.00,
  subscriptionHands: 1000,
  winningShares: 500,
  winningTime: 1642176000000,
  winningFeeDetails: {
    totalFee: '150.00'
  },
  accountId: 'test_account_001',
  status: 'ongoing'
}
```

## 详细测试用例

### 测试用例 1：基本功能验证
**目标**: 验证结束打新基本流程

**步骤**:
1. 进入卖出记录页面
2. 不输入卖出价格，直接点击"结束打新"
3. 验证提示"请先输入有效的卖出价格"
4. 输入卖出价格 "12.50"
5. 点击"结束打新"
6. 验证确认弹框出现，内容包含警告文案
7. 点击确定

**预期结果**:
- ✅ 显示错误提示要求输入价格
- ✅ 确认弹框正确显示
- ✅ 点击确定后开始保存流程

### 测试用例 2：数据保存验证
**目标**: 验证卖出记录正确保存

**步骤**:
1. 按测试用例1操作到确认保存
2. 查看本地存储数据变化
3. 验证股票记录更新

**预期结果**:
```javascript
// 验证保存后的股票记录
{
  // ...原有字段
  sellPrice: 12.50,
  sellShares: 500,
  sellTime: 1642219200000, // 对应卖出日期14:00
  profit: 1100.00, // 净盈亏计算结果
  sellFeeDetails: {
    commission: '75.00',
    stampDuty: '63.00',
    // ...其他费用
    totalFee: '180.50'
  },
  status: 'finished'
}
```

### 测试用例 3：资金流水验证
**目标**: 验证资金流水正确生成

**步骤**:
1. 记录结束打新前的资金流水数量
2. 执行结束打新操作
3. 检查新增的资金流水记录

**预期结果**:
```javascript
// 新增卖出收入记录
{
  type: 'sell',
  accountId: 'test_account_001',
  stockId: 'test_stock_001',
  amount: 6250.00, // 12.50 × 500
  description: '卖出收入 测试股票A 500股 @12.50'
}

// 新增手续费记录
{
  type: 'fee_deduction',
  accountId: 'test_account_001',
  stockId: 'test_stock_001',
  amount: 180.50,
  description: '卖出手续费 测试股票A 500股'
}
```

### 测试用例 4：修改场景验证
**目标**: 验证修改已有卖出记录的回滚机制

**前置条件**: 股票已有卖出记录
```javascript
{
  sellPrice: 11.00,
  sellShares: 500,
  sellFeeDetails: { totalFee: '170.00' }
}
```

**步骤**:
1. 进入已有卖出记录的股票编辑页
2. 修改卖出价格为 "13.00"
3. 点击"结束打新"确认

**预期结果**:
- ✅ 生成回滚记录（恢复原卖出收入和手续费）
- ✅ 生成新的卖出收入和手续费记录
- ✅ 最终股票记录反映新的价格

### 测试用例 5：边界条件测试
**目标**: 验证异常输入处理

**测试场景**:
1. **卖出价格为0**: 输入0，点击结束打新
2. **卖出价格为负数**: 输入-5，点击结束打新
3. **卖出股数超限**: 修改卖出股数为1000（超出中签500股）
4. **无效日期**: 设置异常日期

**预期结果**:
- ✅ 所有无效输入都显示相应错误提示
- ✅ 不会执行保存操作
- ✅ 用户可以重新输入正确数据

### 测试用例 6：资金管理集成测试
**目标**: 验证与资金管理模块的集成

**步骤**:
1. 记录账户初始余额
2. 执行结束打新操作
3. 检查账户余额变化
4. 验证资金流水页面显示

**预期结果**:
- ✅ 账户余额增加 = 卖出金额 - 手续费
- ✅ 资金流水页面显示新记录
- ✅ 时间排序正确（手续费在收入之后）

### 测试用例 7：用户界面测试
**目标**: 验证用户交互体验

**步骤**:
1. 执行完整的结束打新流程
2. 观察提示信息和页面跳转

**预期结果**:
- ✅ 显示"打新结束，记录已保存"成功提示
- ✅ 1.5秒后自动返回上级页面
- ✅ 返回页面显示的状态为"打新结束"

### 测试用例 8：并发和性能测试
**目标**: 验证快速操作的稳定性

**步骤**:
1. 快速连续点击"结束打新"按钮
2. 在保存过程中尝试返回页面
3. 验证数据一致性

**预期结果**:
- ✅ 防止重复提交机制有效
- ✅ 数据保存完整性不受影响
- ✅ 不会产生重复的资金流水记录

## 数据验证工具

### 本地存储检查脚本
```javascript
// 在小程序控制台执行
console.log('=== 股票记录检查 ===')
const stocks = wx.getStorageSync('stocks') || []
const testStock = stocks.find(s => s.id === 'test_stock_001')
console.log('测试股票数据:', testStock)
console.log('状态:', testStock.status)
console.log('卖出价格:', testStock.sellPrice)
console.log('费用明细:', testStock.sellFeeDetails)

console.log('=== 资金流水检查 ===')
const transactions = wx.getStorageSync('transactions') || []
const stockTransactions = transactions.filter(t => t.stockId === 'test_stock_001')
console.log('相关流水记录:', stockTransactions)
```

### 余额计算验证
```javascript
// 验证账户余额计算
const { FundManager } = require('../../utils/fundManager.js')
const fundManager = new FundManager()
const balance = fundManager.getAccountBalance('test_account_001')
console.log('账户余额:', balance)
```

## 问题排查指南

### 常见问题及解决方案

#### 1. 卖出记录保存失败
**症状**: 点击结束打新后显示"操作失败：未找到记录"
**排查**: 
- 检查 stockId 是否正确传递
- 验证本地存储中是否存在对应记录
- 检查数组查找逻辑

#### 2. 资金流水重复
**症状**: 同一次操作产生多条相同记录
**排查**:
- 检查是否有重复点击
- 验证回滚机制是否正常工作
- 检查时间戳生成逻辑

#### 3. 状态未更新
**症状**: 结束打新后状态仍为"进行中"
**排查**:
- 检查 finishStockWithSellRecord 方法执行情况
- 验证本地存储保存是否成功
- 检查页面数据绑定

#### 4. 费用计算错误
**症状**: 显示的盈亏金额不正确
**排查**:
- 检查费用明细计算公式
- 验证买入费用数据来源
- 检查浮点数精度处理

## 性能优化建议

### 1. 减少存储操作
- 合并多次 setStorageSync 调用
- 使用批量更新策略

### 2. 错误处理增强
- 增加 try-catch 包装
- 提供更详细的错误信息

### 3. 用户体验优化
- 添加加载状态提示
- 优化按钮防抖处理

## 测试完成标准

### 功能完整性
- [ ] 所有基础功能测试通过
- [ ] 边界条件处理正确
- [ ] 异常情况恢复机制有效

### 数据一致性
- [ ] 股票记录更新正确
- [ ] 资金流水生成准确
- [ ] 账户余额计算一致

### 用户体验
- [ ] 操作流程顺畅
- [ ] 错误提示清晰
- [ ] 界面响应及时

### 兼容性
- [ ] 新旧数据格式兼容
- [ ] 不同设备测试通过
- [ ] 版本升级平滑

通过以上测试验证，可以确保结束打新功能的完整性和可靠性，为用户提供稳定的打新管理体验。
