# 编辑打新记录费用明细丢失问题修复说明

## 问题描述

用户报告通过编辑打新记录页面修改中签信息后，出现以下问题：
1. **总盈亏计算错误**：重新计算的盈亏不准确
2. **中签费用明细丢失**：winningFeeDetails字段被清空
3. **卖出费用明细丢失**：sellFeeDetails字段被清空
4. **与卖出页面不一致**：通过卖出页面修改是正确的

## 问题根因分析

### 编辑页面vs专业页面的差异

#### 编辑页面（add-stock.js）问题
```javascript
// 错误的保存方式 - 直接替换整个记录
stocks[index] = stockData

// stockData只包含基本字段，缺少费用明细
const stockData = {
  id: this.data.stockId,
  stockName: formData.stockName,
  // ... 基本字段
  profit: 0  // 简单重置为0
  // ❌ 缺少：winningFeeDetails
  // ❌ 缺少：sellFeeDetails  
  // ❌ 缺少：pureProfit
}
```

#### 专业页面（winning-result.js、sell-record.js）正确做法
```javascript
// 正确的保存方式 - 合并保留重要字段
stocks[stockIndex] = {
  ...stocks[stockIndex],  // 保留原有数据
  // 只更新需要修改的字段
  winningShares: winningData.winningShares,
  winningTime: winningData.winningTime,
  winningFeeDetails: winningData.winningFeeDetails  // ✅ 保留费用明细
}
```

## 修复方案

### 1. 保留费用明细字段
✅ **修复编辑保存逻辑**
```javascript
if (this.data.isEdit) {
  const oldStock = stocks[index]
  
  // 合并数据，保留费用明细
  stocks[index] = {
    ...stockData,
    // 保留重要的费用明细字段
    winningFeeDetails: oldStock.winningFeeDetails,
    sellFeeDetails: oldStock.sellFeeDetails,
    // 保留精确的盈亏计算结果
    profit: oldStock.profit,
    pureProfit: oldStock.pureProfit
  }
}
```

### 2. 智能盈亏计算
✅ **条件化盈亏重计算**
```javascript
// 只有在没有详细费用明细时才重新计算盈亏
if (this.data.isEdit) {
  const oldStock = wx.getStorageSync('stocks').find(item => item.id === this.data.stockId)
  if (oldStock && (oldStock.winningFeeDetails || oldStock.sellFeeDetails)) {
    console.log('保留原有的精确盈亏计算，不重新计算')
    // 不修改profit，保留原有计算
  } else {
    stockData.profit = this.calculateProfit(stockData)
  }
}
```

### 3. 增强调试信息
✅ **详细的保存日志**
```javascript
console.log('修改前的股票数据:', {
  id: oldStock.id,
  hasWinningFeeDetails: !!oldStock.winningFeeDetails,
  hasSellFeeDetails: !!oldStock.sellFeeDetails
})
```

## 修复的文件
- **pages/add-stock/add-stock.js** - 编辑打新记录页面的保存逻辑

## 对比验证

### 修复前的问题流程
1. 用户在中签结果页面设置中签信息 → 保存详细费用明细
2. 用户在卖出记录页面设置卖出信息 → 保存详细费用明细
3. 用户在编辑页面修改基本信息 → **丢失所有费用明细** ❌
4. 再次查看卖出页面 → 费用计算错误 ❌

### 修复后的正确流程
1. 用户在中签结果页面设置中签信息 → 保存详细费用明细
2. 用户在卖出记录页面设置卖出信息 → 保存详细费用明细  
3. 用户在编辑页面修改基本信息 → **保留所有费用明细** ✅
4. 再次查看卖出页面 → 费用计算正确 ✅

## 数据完整性保护

### 保护的关键字段
- `winningFeeDetails` - 中签费用明细（包含各项手续费分解）
- `sellFeeDetails` - 卖出费用明细（包含各项手续费分解）
- `profit` - 准确的净盈亏计算结果
- `pureProfit` - 纯盈亏（不含费用）

### 编辑安全策略
- **只更新用户修改的字段**（股票名称、发行价等基本信息）
- **保留系统计算的字段**（费用明细、精确盈亏等）
- **智能判断是否需要重新计算**（有详细费用时保留精确计算）

## 测试验证要点

1. **基础流程测试**
   - [ ] 设置中签信息 → 编辑基本信息 → 检查中签费用明细是否保留
   - [ ] 设置卖出信息 → 编辑基本信息 → 检查卖出费用明细是否保留
   - [ ] 编辑后的盈亏计算是否与编辑前一致

2. **边界情况测试**
   - [ ] 只有中签信息时编辑
   - [ ] 同时有中签和卖出信息时编辑
   - [ ] 新建记录时的正常流程

3. **数据一致性测试**
   - [ ] 编辑页面修改后，卖出页面的计算结果
   - [ ] 资金流水中的费用记录完整性
   - [ ] 账户余额计算的准确性

这个修复确保了编辑页面与专业页面的数据一致性，用户可以安全地编辑基本信息而不会丢失重要的费用计算数据。
