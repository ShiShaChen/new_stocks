# 卖出信息页费用规则迭代说明

## 功能概述
本次迭代对卖出信息录入页面进行了全面优化，实现了自动费用计算、去除手动输入费用项目，提升用户体验和数据准确性。

## 主要修改内容

### 1. 页面布局调整
- **顶部增加成本价显示**：在股票信息卡片中突出显示打新成本价（发行价）
- **去除手续费输入框**：移除原有的"卖出手续费"和"其他费用"输入框
- **优化信息层次**：成本价单独显示区域，更加醒目

### 2. 费用计算规则实现
实现按港股交易规则的精确费用计算：

#### 费用项目及费率
- **佣金**：固定75港元
- **印花税**：卖出金额的0.1%
- **交易徵费**：卖出金额的0.00285%
- **交易费**：卖出金额的0.00565%
- **结算费**：卖出金额的0.002%，最低3港元

#### 计算基数
- 所有费用均按"中签数量 × 卖出价格"计算
- 使用四舍五入保留两位小数
- 结算费特殊处理：计算值小于3元时按3元收取

#### 总费用构成
**总费用 = 印花税 + 交易徵费 + 交易费 + 结算费 + 佣金**

### 3. 实时计算功能
- **价格输入响应**：用户输入卖出价格时实时计算各项费用
- **股数调整响应**：修改卖出股数时重新计算费用
- **明细展示**：详细显示各项费用的计算结果和费率说明
- **盈亏计算**：综合考虑买入成本、卖出收入和所有费用

### 4. 数据存储优化
- **费用详情保存**：将计算得出的费用明细保存到股票记录中
- **数据结构更新**：移除手动输入的费用字段，增加费用详情对象
- **向后兼容**：保持与现有数据的兼容性

## 技术实现要点

### 1. 精度处理
```javascript
// 使用Math.round确保计算精度
const stampDuty = Math.round(baseAmount * 0.001 * 100) / 100
```

### 2. 结算费特殊处理
```javascript
// 结算费最低3元逻辑
let settlementFee = Math.round(baseAmount * 0.00002 * 100) / 100
if (settlementFee < 3.00) {
  settlementFee = 3.00
}
```

### 3. 费用明细展示
- 清晰的卡片式布局展示各项费用
- 费率说明帮助用户理解计算规则
- 总费用突出显示

## 用户体验提升

### 1. 操作简化
- 减少用户输入项目，避免手动计算错误
- 实时反馈，所见即所得
- 自动填充默认值，减少操作步骤

### 2. 信息透明
- 详细的费用明细展示
- 计算规则说明
- 实时的盈亏计算结果

### 3. 数据准确
- 标准化计算规则，避免人为错误
- 精确的浮点数处理
- 完整的费用记录保存

## 影响的文件

### 页面文件
- `pages/sell-record/sell-record.js` - 核心逻辑实现
- `pages/sell-record/sell-record.wxml` - 界面布局调整
- `pages/sell-record/sell-record.wxss` - 样式优化

### 主要修改方法
- `calculateSellFees()` - 费用计算核心方法
- `calculateProfit()` - 盈亏计算方法
- `onSubmit()` - 表单提交逻辑
- `saveSellRecord()` - 数据保存逻辑

## 测试建议

### 1. 功能测试
- 验证各种卖出价格下的费用计算准确性
- 测试结算费3元最低限制逻辑
- 确认费用明细显示完整性

### 2. 边界测试
- 极小金额的费用计算
- 最大中签数量的处理
- 数据精度边界情况

### 3. 兼容性测试
- 新老数据格式兼容性
- 页面在不同设备上的显示效果
- 与其他页面的数据交互

## 后续优化方向

1. **费率配置化**：将费率参数提取为可配置项
2. **计算规则升级**：支持更复杂的费用计算规则
3. **费用历史对比**：显示费用变化趋势
4. **税费优化建议**：根据交易情况提供优化建议

---
*更新时间：2025年7月12日*
*版本：v1.0*
