<!--pages/add-stock/add-stock.wxml-->
<view class="container">
  <form bindsubmit="onSubmit">
    <view class="form-section">
      <!-- è´¦æˆ·é€‰æ‹© -->
      <view class="form-item">
        <text class="form-label">æ‰€å±è´¦æˆ· *</text>
        <view class="account-selector" bindtap="onSelectAccount">
          <text class="account-name">{{selectedAccount.name}}</text>
          <text class="selector-arrow">></text>
        </view>
      </view>

      <!-- æ¨¡æ¿é€‰æ‹©ï¼ˆä»…æ–°å¢æ—¶æ˜¾ç¤ºï¼‰ -->
      <view class="template-section" wx:if="{{!isEdit}}">
        <view class="template-tip" wx:if="{{!isFromTemplate}}">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">ä½¿ç”¨æ¨¡æ¿å¿«é€Ÿå¡«å……è‚¡ç¥¨ä¿¡æ¯</text>
          <view class="template-btn" bindtap="showTemplateSelector">
            <text>é€‰æ‹©æ¨¡æ¿</text>
          </view>
        </view>
        <view class="template-selected" wx:if="{{isFromTemplate}}">
          <view class="selected-info">
            <text class="selected-icon">âœ“</text>
            <text class="selected-text">å·²åº”ç”¨æ¨¡æ¿ï¼š{{selectedTemplate.stockName}}</text>
          </view>
          <view class="clear-template" bindtap="clearTemplate">
            <text>æ¸…é™¤</text>
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">è‚¡ç¥¨åç§° *</text>
        <input class="form-input" name="stockName" placeholder="è¯·è¾“å…¥è‚¡ç¥¨åç§°" value="{{formData.stockName}}" disabled="{{readonly || isFromTemplate}}" />
      </view>

      <view class="form-item" wx:if="{{formData.stockCode}}">
        <text class="form-label">è‚¡ç¥¨ä»£ç </text>
        <input class="form-input" name="stockCode" placeholder="è‚¡ç¥¨ä»£ç " value="{{formData.stockCode}}" disabled="{{readonly || isFromTemplate}}" />
      </view>

      <view class="form-item">
        <text class="form-label">è‚¡ç¥¨å‘è¡Œä»· *</text>
        <input class="form-input" name="issuePrice" type="digit" placeholder="è¯·è¾“å…¥å‘è¡Œä»·" value="{{formData.issuePrice}}" disabled="{{readonly || isFromTemplate}}" />
      </view>

      <view class="form-item">
        <text class="form-label">æ‰“æ–°å¥—é¤è´¹ç”¨ *</text>
        <input class="form-input" name="packageFee" type="digit" placeholder="è¯·è¾“å…¥å¥—é¤è´¹ç”¨" value="{{formData.packageFee}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">ç”³è´­æ•°é‡ *</text>
        <input class="form-input" name="subscriptionHands" type="number" placeholder="è¯·è¾“å…¥ç”³è´­æ•°é‡" value="{{formData.subscriptionHands}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">æ‰“æ–°æ–¹æ³• *</text>
        <radio-group name="subscriptionMethod" bindchange="onSubscriptionMethodChange">
          <label class="radio-item">
            <radio value="cash" checked="{{formData.subscriptionMethod === 'cash'}}" disabled="{{readonly}}" />
            <text>ç°é‡‘</text>
          </label>
          <label class="radio-item">
            <radio value="margin90" checked="{{formData.subscriptionMethod === 'margin90'}}" disabled="{{readonly}}" />
            <text>90å­–å±•</text>
          </label>
        </radio-group>
      </view>

      <view class="form-item" wx:if="{{isEdit}}">
        <text class="form-label">æ‰“æ–°çŠ¶æ€</text>
        <radio-group name="status" bindchange="onStatusChange">
          <label class="radio-item">
            <radio value="ongoing" checked="{{formData.status === 'ongoing'}}" disabled="{{readonly}}" />
            <text>æ‰“æ–°ä¸­</text>
          </label>
          <label class="radio-item">
            <radio value="finished" checked="{{formData.status === 'finished'}}" disabled="{{readonly}}" />
            <text>æ‰“æ–°ç»“æŸ</text>
          </label>
        </radio-group>
        <text class="form-tip" wx:if="{{formData.status === 'finished'}}">æ‰“æ–°ç»“æŸåï¼Œæ‰€æœ‰ä¿¡æ¯å°†ä¸å¯ä¿®æ”¹</text>
      </view>
    </view>

    <!-- ä¸­ç­¾ä¿¡æ¯ -->
    <view class="form-section" wx:if="{{isEdit && formData.winningTime}}">>
      <view class="section-title">ä¸­ç­¾ä¿¡æ¯</view>
      <view class="form-item">
        <text class="form-label">ä¸­ç­¾æ•°</text>
        <text class="form-value">{{formData.winningShares}} è‚¡</text>
      </view>
      <view class="form-item" wx:if="{{formData.winningTime}}">
        <text class="form-label">ä¸­ç­¾æ—¥æœŸ</text>
        <text class="form-value">{{formData.winningDateStr}}</text>
      </view>
      
      <!-- ä¸­ç­¾è´¹ç”¨æ˜ç»† -->
      <view class="fee-details" wx:if="{{formData.winningFeeDetails}}">
        <view class="fee-title">ä¸­ç­¾è´¹ç”¨æ˜ç»†</view>
        <view class="fee-item">
          <text class="fee-label">ç»çºªä½£é‡‘ï¼š</text>
          <text class="fee-value">Â¥{{formData.winningFeeDetails.brokerageCommission || '0.00'}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">é¦™æ¸¯è”äº¤æ‰€äº¤æ˜“è´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.winningFeeDetails.tradingFee}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">è¯ç›‘ä¼šäº¤æ˜“ä¼šè´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.winningFeeDetails.tradingLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">ä¼šè´¢å±€äº¤æ˜“ä¼šè´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.winningFeeDetails.afrcLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">å¥—é¤è´¹ç”¨ï¼š</text>
          <text class="fee-value">Â¥{{formData.winningFeeDetails.packageFee}}</text>
        </view>
        <view class="fee-total">
          <text class="fee-total-label">æ€»è´¹ç”¨ï¼š</text>
          <text class="fee-total-value">Â¥{{formData.winningFeeDetails.totalFee}}</text>
        </view>
      </view>
    </view>

    <!-- å–å‡ºä¿¡æ¯ -->
    <view class="form-section" wx:if="{{isEdit && formData.sellPrice > 0}}">
      <view class="section-title">å–å‡ºä¿¡æ¯</view>
      <view class="form-item">
        <text class="form-label">å–å‡ºä»·æ ¼</text>
        <text class="form-value">Â¥{{formData.sellPrice}}</text>
      </view>
      <view class="form-item">
        <text class="form-label">å–å‡ºè‚¡æ•°</text>
        <text class="form-value">{{formData.sellShares}} è‚¡</text>
      </view>
      <view class="form-item">
        <text class="form-label">ç›ˆåˆ©é‡‘é¢</text>
        <text class="form-value profit-{{formData.profit >= 0 ? 'positive' : 'negative'}}">
          {{formData.profit >= 0 ? '+' : ''}}{{formData.profit}}å…ƒ
        </text>
      </view>
      <view class="form-item" wx:if="{{formData.sellTime}}">
        <text class="form-label">å–å‡ºæ—¥æœŸ</text>
        <text class="form-value">{{formData.sellDateStr}}</text>
      </view>
      
      <!-- å–å‡ºè´¹ç”¨æ˜ç»† -->
      <view class="fee-details" wx:if="{{formData.sellFeeDetails}}">
        <view class="fee-title">å–å‡ºè´¹ç”¨æ˜ç»†</view>
        <view class="fee-item">
          <text class="fee-label">ç»çºªä½£é‡‘ï¼š</text>
          <text class="fee-value">Â¥{{formData.sellFeeDetails.commission}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">å°èŠ±ç¨ï¼š</text>
          <text class="fee-value">Â¥{{formData.sellFeeDetails.stampDuty}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">äº¤æ˜“å¾µè´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.sellFeeDetails.tradingLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">äº¤æ˜“è´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.sellFeeDetails.tradingFee}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">ç»“ç®—è´¹ï¼š</text>
          <text class="fee-value">Â¥{{formData.sellFeeDetails.settlementFee}}</text>
        </view>
        <view class="fee-total">
          <text class="fee-total-label">æ€»è´¹ç”¨ï¼š</text>
          <text class="fee-total-value">Â¥{{formData.sellFeeDetails.totalFee}}</text>
        </view>
      </view>
    </view>

    <view class="button-group" wx:if="{{!readonly}}">
      <button formType="submit" class="btn-primary">
        {{isEdit ? 'æ›´æ–°è®°å½•' : 'ä¿å­˜è®°å½•'}}
      </button>
      <button type="default" bindtap="onCancel" class="btn-secondary">
        å–æ¶ˆ
      </button>
    </view>

    <!-- åªè¯»æ¨¡å¼ä¸‹çš„æ“ä½œæŒ‰é’® -->
    <view class="button-group" wx:if="{{readonly}}">
      <button bindtap="editRecord" class="btn-primary" wx:if="{{formData.status === 'ongoing'}}">
        ç¼–è¾‘è®°å½•
      </button>
      <button bindtap="addWinning" class="btn-secondary" wx:if="{{formData.status === 'ongoing'}}">
        {{formData.winningShares > 0 ? 'ä¿®æ”¹ä¸­ç­¾' : 'å½•å…¥ä¸­ç­¾'}}
      </button>
      <button bindtap="addSell" class="btn-secondary" wx:if="{{formData.status === 'ongoing' && formData.winningShares > 0}}">
        {{formData.sellPrice > 0 ? 'ä¿®æ”¹å–å‡º' : 'å½•å…¥å–å‡º'}}
      </button>
      <view class="status-tip" wx:if="{{formData.status === 'finished'}}">
        <text class="tip-text">è¯¥è®°å½•å·²å®Œæˆï¼Œæ— æ³•è¿›è¡Œæ“ä½œ</text>
      </view>
    </view>
  </form>

  <!-- è´¦æˆ·é€‰æ‹©å¼¹çª— -->
  <view class="account-modal" wx:if="{{showAccountModal}}" bindtap="onCloseAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è´¦æˆ·</text>
        <button class="add-account-btn" bindtap="onAddAccount">+ æ–°å¢è´¦æˆ·</button>
      </view>
      
      <view class="account-list">
        <view 
          class="account-item {{selectedAccount.id === item.id ? 'active' : ''}}" 
          wx:for="{{accountList}}" 
          wx:key="id"
          bindtap="onChooseAccount"
          data-account="{{item}}"
        >
          <view class="account-info">
            <text class="account-name">{{item.name}}</text>
            <text class="account-desc" wx:if="{{item.isDefault}}">é»˜è®¤è´¦æˆ·</text>
          </view>
          <text class="check-icon" wx:if="{{selectedAccount.id === item.id}}">âœ“</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ–°å¢è´¦æˆ·å¼¹çª— -->
  <view class="add-account-modal" wx:if="{{showAddAccountModal}}" bindtap="onCloseAddAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">æ–°å¢è´¦æˆ·</text>
      </view>
      
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">è´¦æˆ·åç§°</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥è´¦æˆ·åç§°" 
            value="{{newAccountName}}"
            bindinput="onNewAccountNameChange"
            maxlength="20"
          />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="onCloseAddAccountModal">å–æ¶ˆ</button>
        <button 
          class="btn-confirm" 
          bindtap="onCreateAccount"
          disabled="{{!newAccountName}}"
        >
          åˆ›å»º
        </button>
      </view>
    </view>
  </view>

  <!-- æ¨¡æ¿é€‰æ‹©å¼¹çª— -->
  <view class="template-modal" wx:if="{{showTemplateModal}}" bindtap="closeTemplateModal">
    <view class="modal-content template-modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è‚¡ç¥¨æ¨¡æ¿</text>
        <view class="modal-close" bindtap="closeTemplateModal">
          <text>Ã—</text>
        </view>
      </view>
      
      <view class="template-list">
        <view 
          class="template-item"
          wx:for="{{templates}}"
          wx:key="id"
          data-template="{{item}}"
          bindtap="selectTemplate"
        >
          <view class="template-info">
            <text class="template-name">{{item.stockName}}</text>
            <text class="template-code">{{item.stockCode}}</text>
          </view>
          <view class="template-price">
            <text class="price-label">å‘è¡Œä»·</text>
            <text class="price-value">Â¥{{item.issuePrice}}</text>
          </view>
          <view class="template-stats" wx:if="{{item.usedAccounts.length > 0}}">
            <text class="stats-text">å·²ç”¨äº {{item.usedAccounts.length}} ä¸ªè´¦æˆ·</text>
          </view>
        </view>
        
        <view class="empty-template" wx:if="{{templates.length === 0}}">
          <text>æš‚æ— å¯ç”¨æ¨¡æ¿</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="footer-tip">
          <text>æç¤ºï¼šé€‰æ‹©æ¨¡æ¿åå°†è‡ªåŠ¨å¡«å……è‚¡ç¥¨åç§°å’Œå‘è¡Œä»·</text>
        </view>
      </view>
    </view>
  </view>
</view>
