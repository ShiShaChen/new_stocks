<!--pages/add-stock/add-stock.wxml-->
<view class="container">
  <form bindsubmit="onSubmit">
    <view class="form-section">
      <!-- 账户选择 -->
      <view class="form-item">
        <text class="form-label">所属账户 *</text>
        <view class="account-selector" bindtap="onSelectAccount">
          <text class="account-name">{{selectedAccount.name}}</text>
          <text class="selector-arrow">></text>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">股票名称 *</text>
        <input class="form-input" name="stockName" placeholder="请输入股票名称" value="{{formData.stockName}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">股票发行价 *</text>
        <input class="form-input" name="issuePrice" type="digit" placeholder="请输入发行价" value="{{formData.issuePrice}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">打新套餐费用 *</text>
        <input class="form-input" name="packageFee" type="digit" placeholder="请输入套餐费用" value="{{formData.packageFee}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">申购手数 *</text>
        <input class="form-input" name="subscriptionHands" type="number" placeholder="请输入申购手数" value="{{formData.subscriptionHands}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">打新手续费</text>
        <input class="form-input" name="serviceFee" type="digit" placeholder="请输入手续费" value="{{formData.serviceFee}}" disabled="{{readonly}}" />
      </view>

      <view class="form-item">
        <text class="form-label">打新方法 *</text>
        <radio-group name="subscriptionMethod" bindchange="onSubscriptionMethodChange">
          <label class="radio-item">
            <radio value="cash" checked="{{formData.subscriptionMethod === 'cash'}}" disabled="{{readonly}}" />
            <text>现金</text>
          </label>
          <label class="radio-item">
            <radio value="margin90" checked="{{formData.subscriptionMethod === 'margin90'}}" disabled="{{readonly}}" />
            <text>90孖展</text>
          </label>
        </radio-group>
      </view>

      <view class="form-item" wx:if="{{isEdit}}">
        <text class="form-label">打新状态</text>
        <radio-group name="status" bindchange="onStatusChange">
          <label class="radio-item">
            <radio value="ongoing" checked="{{formData.status === 'ongoing'}}" disabled="{{readonly}}" />
            <text>打新中</text>
          </label>
          <label class="radio-item">
            <radio value="finished" checked="{{formData.status === 'finished'}}" disabled="{{readonly}}" />
            <text>打新结束</text>
          </label>
        </radio-group>
        <text class="form-tip" wx:if="{{formData.status === 'finished'}}">打新结束后，所有信息将不可修改</text>
      </view>
    </view>

    <!-- 中签信息 -->
    <view class="form-section" wx:if="{{isEdit && formData.winningShares > 0}}">
      <view class="section-title">中签信息</view>
      <view class="form-item">
        <text class="form-label">中签股数</text>
        <text class="form-value">{{formData.winningShares}} 股</text>
      </view>
      <view class="form-item" wx:if="{{formData.winningTime}}">
        <text class="form-label">中签日期</text>
        <text class="form-value">{{formData.winningDateStr}}</text>
      </view>
      
      <!-- 中签费用明细 -->
      <view class="fee-details" wx:if="{{formData.winningFeeDetails}}">
        <view class="fee-title">中签费用明细</view>
        <view class="fee-item">
          <text class="fee-label">印花税：</text>
          <text class="fee-value">¥{{formData.winningFeeDetails.stampDuty}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">交易费：</text>
          <text class="fee-value">¥{{formData.winningFeeDetails.tradingFee}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">交易征费：</text>
          <text class="fee-value">¥{{formData.winningFeeDetails.tradingLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">会财局交易征费：</text>
          <text class="fee-value">¥{{formData.winningFeeDetails.afrcLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">套餐费用：</text>
          <text class="fee-value">¥{{formData.winningFeeDetails.packageFee}}</text>
        </view>
        <view class="fee-total">
          <text class="fee-total-label">总费用：</text>
          <text class="fee-total-value">¥{{formData.winningFeeDetails.totalFee}}</text>
        </view>
      </view>
    </view>

    <!-- 卖出信息 -->
    <view class="form-section" wx:if="{{isEdit && formData.sellPrice > 0}}">
      <view class="section-title">卖出信息</view>
      <view class="form-item">
        <text class="form-label">卖出价格</text>
        <text class="form-value">¥{{formData.sellPrice}}</text>
      </view>
      <view class="form-item">
        <text class="form-label">卖出股数</text>
        <text class="form-value">{{formData.sellShares}} 股</text>
      </view>
      <view class="form-item">
        <text class="form-label">盈利金额</text>
        <text class="form-value profit-{{formData.profit >= 0 ? 'positive' : 'negative'}}">
          {{formData.profit >= 0 ? '+' : ''}}{{formData.profit}}元
        </text>
      </view>
      <view class="form-item" wx:if="{{formData.sellTime}}">
        <text class="form-label">卖出日期</text>
        <text class="form-value">{{formData.sellDateStr}}</text>
      </view>
      
      <!-- 卖出费用明细 -->
      <view class="fee-details" wx:if="{{formData.sellFeeDetails}}">
        <view class="fee-title">卖出费用明细</view>
        <view class="fee-item">
          <text class="fee-label">佣金：</text>
          <text class="fee-value">¥{{formData.sellFeeDetails.commission}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">印花税：</text>
          <text class="fee-value">¥{{formData.sellFeeDetails.stampDuty}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">交易徵费：</text>
          <text class="fee-value">¥{{formData.sellFeeDetails.tradingLevy}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">交易费：</text>
          <text class="fee-value">¥{{formData.sellFeeDetails.tradingFee}}</text>
        </view>
        <view class="fee-item">
          <text class="fee-label">结算费：</text>
          <text class="fee-value">¥{{formData.sellFeeDetails.settlementFee}}</text>
        </view>
        <view class="fee-total">
          <text class="fee-total-label">总费用：</text>
          <text class="fee-total-value">¥{{formData.sellFeeDetails.totalFee}}</text>
        </view>
      </view>
    </view>

    <view class="button-group" wx:if="{{!readonly}}">
      <button formType="submit" class="btn-primary">
        {{isEdit ? '更新记录' : '保存记录'}}
      </button>
      <button type="default" bindtap="onCancel" class="btn-secondary">
        取消
      </button>
    </view>

    <!-- 只读模式下的操作按钮 -->
    <view class="button-group" wx:if="{{readonly}}">
      <button bindtap="editRecord" class="btn-primary" wx:if="{{formData.status === 'ongoing'}}">
        编辑记录
      </button>
      <button bindtap="addWinning" class="btn-secondary" wx:if="{{formData.status === 'ongoing'}}">
        {{formData.winningShares > 0 ? '修改中签' : '录入中签'}}
      </button>
      <button bindtap="addSell" class="btn-secondary" wx:if="{{formData.status === 'ongoing' && formData.winningShares > 0}}">
        {{formData.sellPrice > 0 ? '修改卖出' : '录入卖出'}}
      </button>
      <view class="status-tip" wx:if="{{formData.status === 'finished'}}">
        <text class="tip-text">该记录已完成，无法进行操作</text>
      </view>
    </view>
  </form>

  <!-- 账户选择弹窗 -->
  <view class="account-modal" wx:if="{{showAccountModal}}" bindtap="onCloseAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">选择账户</text>
        <button class="add-account-btn" bindtap="onAddAccount">+ 新增账户</button>
      </view>
      
      <view class="account-list">
        <view 
          class="account-item {{selectedAccount.id === item.id ? 'active' : ''}}" 
          wx:for="{{accountList}}" 
          wx:key="id"
          bindtap="onChooseAccount"
          data-account="{{item}}"
        >
          <view class="account-info">
            <text class="account-name">{{item.name}}</text>
            <text class="account-desc" wx:if="{{item.isDefault}}">默认账户</text>
          </view>
          <text class="check-icon" wx:if="{{selectedAccount.id === item.id}}">✓</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 新增账户弹窗 -->
  <view class="add-account-modal" wx:if="{{showAddAccountModal}}" bindtap="onCloseAddAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">新增账户</text>
      </view>
      
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">账户名称</text>
          <input 
            class="form-input" 
            placeholder="请输入账户名称" 
            value="{{newAccountName}}"
            bindinput="onNewAccountNameChange"
            maxlength="20"
          />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="onCloseAddAccountModal">取消</button>
        <button 
          class="btn-confirm" 
          bindtap="onCreateAccount"
          disabled="{{!newAccountName}}"
        >
          创建
        </button>
      </view>
    </view>
  </view>
</view>
