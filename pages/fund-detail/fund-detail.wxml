<!--pages/fund-detail/fund-detail.wxml-->
<wxs module="formatter" src="../../utils/formatter.wxs"></wxs>

<view class="container">
  <!-- ç²¾ç¾å¤´éƒ¨åŒºåŸŸ -->
  <view class="header-wrapper">
    <view class="header-bg"></view>
    <view class="header-content">
      <!-- è´¦æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <view class="account-header" wx:if="{{accountFunds}}">
        <view class="account-info">
          <view class="account-avatar">
            <text class="avatar-icon">ğŸ’¼</text>
          </view>
          <view class="account-details">
            <text class="account-name">{{currentAccount.name}}</text>
            <text class="account-subtitle">èµ„é‡‘æ˜ç»†</text>
          </view>
        </view>
        <button class="filter-toggle" bindtap="showFilterModal">
          <text class="filter-icon">ğŸ›ï¸</text>
          <text class="filter-text">ç­›é€‰</text>
        </button>
      </view>
      
      <!-- ä½™é¢å±•ç¤ºå¡ç‰‡ -->
      <view class="balance-showcase" wx:if="{{accountFunds}}">
        <view class="balance-main">
          <text class="balance-label">è´¦æˆ·ä½™é¢</text>
          <text class="balance-amount">{{formatter.formatAmount(accountFunds.balances.HKD, 'HKD')}}</text>
        </view>
        <view class="balance-stats">
          <view class="stat-item">
            <text class="stat-icon">ğŸ“ˆ</text>
            <view class="stat-content">
              <text class="stat-value">{{formatter.formatAmount(accountFunds.totalDeposit.HKD, 'HKD')}}</text>
              <text class="stat-label">ç´¯è®¡è½¬å…¥</text>
            </view>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-icon">ğŸ“‰</text>
            <view class="stat-content">
              <text class="stat-value">{{formatter.formatAmount(accountFunds.totalWithdraw.HKD, 'HKD')}}</text>
              <text class="stat-label">ç´¯è®¡è½¬å‡º</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è®°å½•åˆ—è¡¨åŒºåŸŸ -->
  <view class="records-wrapper">
    <!-- åˆ—è¡¨å¤´éƒ¨ -->
    <view class="list-header" wx:if="{{fundRecords.length > 0}}">
      <view class="header-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">èµ„é‡‘æµæ°´</text>
      </view>
      <view class="record-summary">
        <text class="summary-count">{{fundRecords.length}}æ¡è®°å½•</text>
      </view>
    </view>
    
    <!-- è®°å½•å¡ç‰‡åˆ—è¡¨ -->
    <view class="record-cards" wx:if="{{fundRecords.length > 0}}">
      <view 
        class="record-card" 
        wx:for="{{fundRecords}}" 
        wx:key="id"
      >
        <!-- ç¬¬ä¸€è¡Œï¼šç±»å‹å›¾æ ‡ã€æ“ä½œç±»å‹ã€æ—¶é—´ã€çŠ¶æ€ -->
        <view class="card-row-first">
          <view class="record-main-info">
            <view class="type-icon {{item.amountColorClass}}">
              <text>{{item.icon}}</text>
            </view>
            <view class="record-details">
              <text class="type-name">{{item.typeText}}</text>
              <view class="record-meta">
                <text class="datetime-text">{{item.businessDateTime || item.formattedDateTime}}</text>
                <view class="status-badge {{item.status}}">
                  <text class="status-text">{{item.status === 'pending' ? 'å¤„ç†ä¸­' : item.status === 'completed' ? 'å·²å®Œæˆ' : 'å¤±è´¥'}}</text>
                </view>
              </view>
            </view>
          </view>
          <view class="amount-display">
            <text class="amount-value {{item.amountColorClass}}">
              {{item.recordType === 'fund' ? (item.type === 'deposit' ? '+' : '-') : ((item.originalType === 'sell' || item.originalType === 'allot_refund' || item.originalType === 'fee_refund') ? '+' : '-')}}{{formatter.formatAmount(item.amount, item.currency)}}
            </text>
          </view>
        </view>
        
        <!-- ç¬¬äºŒè¡Œï¼šå¤‡æ³¨å’Œæ“ä½œæŒ‰é’® -->
        <view class="card-row-second">
          <!-- å¤‡æ³¨ä¿¡æ¯ -->
          <view class="description-section" bindtap="showDescriptionModal" data-description="{{item.description || item.displayDescription}}">
            <text class="description-text">{{item.displayDescription}}</text>
            <text class="expand-hint" wx:if="{{item.description && item.description.length > 20}}">...</text>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="action-buttons" wx:if="{{item.recordType === 'fund'}}">
            <button class="action-btn edit" bindtap="onEditRecord" data-record="{{item}}" wx:if="{{item.status === 'pending'}}">
              <text class="btn-icon">âœï¸</text>
            </button>
            <button class="action-btn delete" bindtap="onDeleteRecord" data-record="{{item}}">
              <text class="btn-icon">åˆ é™¤</text>
            </button>
          </view>
        </view>
        
        <!-- ä¸šåŠ¡è®°å½•æ ‡ç­¾ -->
        <view class="business-label" wx:if="{{item.recordType === 'business'}}">
          <text class="label-icon">ğŸ¢</text>
          <text class="label-text">ä¸šåŠ¡è®°å½•</text>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more-section" wx:if="{{hasMore && fundRecords.length > 0}}">
      <button class="load-more-btn" bindtap="loadRecords" data-append="true" loading="{{isLoading}}">
        <text class="load-icon">{{isLoading ? 'â³' : 'â¬‡ï¸'}}</text>
        <text class="load-text">{{isLoading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
      </button>
    </view>
    
    <!-- ç²¾ç¾ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{fundRecords.length === 0 && !isLoading}}">
      <view class="empty-illustration">
        <image class="empty-image" src="/images/empty.png" mode="aspectFit"></image>
        <view class="empty-decoration"></view>
      </view>
      <view class="empty-content">
        <text class="empty-title">æš‚æ— èµ„é‡‘è®°å½•</text>
        <text class="empty-subtitle">å¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€ç¬”èµ„é‡‘æµæ°´å§</text>
      </view>
      <button class="empty-action-btn" bindtap="onAddRecord">
        <text class="btn-icon">âœ¨</text>
        <text class="btn-text">æ·»åŠ è®°å½•</text>
      </button>
    </view>
  </view>
</view>

<!-- ç²¾ç¾ç­›é€‰å¼¹çª— -->
<view class="filter-modal {{showFilterModal ? 'show' : ''}}" bindtap="closeFilterModal" catchtouchmove="preventTouchMove">
  <view class="modal-backdrop"></view>
  <view class="modal-container" catchtap="stopPropagation" catchtouchmove="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
      <view class="modal-close" bindtap="closeFilterModal">
        <text>Ã—</text>
      </view>
    </view>
    
    <scroll-view 
      class="filter-content" 
      scroll-y 
      enhanced 
      show-scrollbar="{{false}}"
      enable-passive="{{false}}"
      catchtouchmove="stopPropagation"
    >
      <!-- ç±»å‹ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-title">
          <text class="title-icon">ğŸ“‹</text>
          <text class="title-text">è®°å½•ç±»å‹</text>
        </view>
        <view class="filter-options-horizontal">
          <button 
            class="filter-option-small {{filterType === item.value ? 'active' : ''}}"
            wx:for="{{typeOptions}}"
            wx:key="value"
            bindtap="onFilterChange"
            data-field="filterType"
            data-value="{{item.value}}"
          >
            <text class="option-text-small">{{item.label}}</text>
            <view class="option-check-small" wx:if="{{filterType === item.value}}">âœ“</view>
          </button>
        </view>
      </view>
      
      <!-- å¸ç§ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-title">
          <text class="title-icon">ğŸ’°</text>
          <text class="title-text">å¸ç§</text>
        </view>
        <view class="filter-options-horizontal">
          <button 
            class="filter-option-small {{filterCurrency === item.value ? 'active' : ''}}"
            wx:for="{{currencyOptions}}"
            wx:key="value"
            bindtap="onFilterChange"
            data-field="filterCurrency"
            data-value="{{item.value}}"
          >
            <text class="option-text-small">{{item.label}}</text>
            <view class="option-check-small" wx:if="{{filterCurrency === item.value}}">âœ“</view>
          </button>
        </view>
      </view>
      
      <!-- çŠ¶æ€ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-title">
          <text class="title-icon">ğŸ¯</text>
          <text class="title-text">çŠ¶æ€</text>
        </view>
        <view class="filter-options-horizontal">
          <button 
            class="filter-option-small {{filterStatus === item.value ? 'active' : ''}}"
            wx:for="{{statusOptions}}"
            wx:key="value"
            bindtap="onFilterChange"
            data-field="filterStatus"
            data-value="{{item.value}}"
          >
            <text class="option-text-small">{{item.label}}</text>
            <view class="option-check-small" wx:if="{{filterStatus === item.value}}">âœ“</view>
          </button>
        </view>
      </view>
      
      <!-- æ—¶é—´ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-title">
          <text class="title-icon">ğŸ“…</text>
          <text class="title-text">æ—¶é—´èŒƒå›´</text>
        </view>
        <view class="filter-options-horizontal">
          <button 
            class="filter-option-small {{dateRange === item.value ? 'active' : ''}}"
            wx:for="{{dateOptions}}"
            wx:key="value"
            bindtap="onFilterChange"
            data-field="dateRange"
            data-value="{{item.value}}"
          >
            <text class="option-text-small">{{item.label}}</text>
            <view class="option-check-small" wx:if="{{dateRange === item.value}}">âœ“</view>
          </button>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <button class="footer-btn reset" bindtap="resetFilter">
        <text class="btn-icon">ğŸ”„</text>
        <text class="btn-text">é‡ç½®</text>
      </button>
      <button class="footer-btn apply" bindtap="applyFilter">
        <text class="btn-icon">âœ“</text>
        <text class="btn-text">åº”ç”¨ç­›é€‰</text>
      </button>
    </view>
  </view>
</view>

<!-- å¤‡æ³¨è¯¦æƒ…å¼¹æ¡† -->
<view class="description-modal {{showDescriptionModal ? 'show' : ''}}" bindtap="hideDescriptionModal">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¤‡æ³¨è¯¦æƒ…</text>
      <button class="modal-close-btn" bindtap="hideDescriptionModal">
        <text class="close-icon">âœ•</text>
      </button>
    </view>
    <view class="modal-content">
      <text class="full-description">{{currentDescription}}</text>
    </view>
  </view>
</view>