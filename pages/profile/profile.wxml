<!--pages/profile/profile.wxml-->
<wxs module="formatter" src="../../utils/formatter.wxs"></wxs>

<view class="container">
  <!-- 用户信息区域 -->
  <view class="user-section" wx:if="{{userInfo}}">
    <view class="user-info">
      <image class="avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
      <view class="user-details">
        <text class="nickname">{{userInfo.nickName}}</text>
        <text class="user-desc">打新投资者</text>
        <text class="login-time" wx:if="{{userInfo.loginTimeStr}}">登录时间：{{userInfo.loginTimeStr}}</text>
      </view>
      <button class="edit-user-btn" bindtap="editUserInfo">
        <text class="edit-icon">编辑</text>
      </button>
    </view>
  </view>

  <!-- 未登录状态 -->
  <view class="login-section" wx:if="{{!userInfo}}">
    <view class="login-prompt">
      <image class="login-icon" src="/images/logo.png" mode="aspectFit"></image>
      <text class="login-text">请先登录</text>
      <button class="login-btn" bindtap="onLogin">立即登录</button>
    </view>
  </view>

     <!-- 当前账户显示 -->
     <view class="current-account-section">
      <view class="account-header">
        <text class="section-title">当前账户</text>
        <text class="current-account-name">{{currentAccount.name}}</text>
      </view>
      <button class="switch-account-btn" bindtap="onSwitchAccount">
        切换账户
      </button>
    </view>

  <!-- 功能菜单 -->
  <view class="menu-section" wx:if="{{userInfo}}">
    <!-- 资金概览 -->
    <view class="funds-overview-section">
      <view class="funds-header">
        <view class="funds-header-left">
          <text class="section-title">资金概览</text>
        </view>
        <view class="funds-header-right">
          <view class="funds-manage-btn" bindtap="onFundManagement">管理资金</view>
        </view>
      </view>
      
      <!-- 总资金统计 -->
      <view class="total-funds-card" wx:if="{{fundsSummary}}">
        <view class="total-funds-title">全部账户资金</view>
        <view class="funds-row-center">
          <view class="fund-item-full">
            <text class="fund-label">港币余额</text>
            <text class="fund-amount hkd">{{formatter.formatAmount(fundsSummary.totalBalances.HKD, 'HKD')}}</text>
          </view>
        </view>
      </view>

      <!-- 当前账户资金 -->
      <view class="current-funds-card" wx:if="{{currentAccountFunds}}">
        <view class="current-funds-title">{{currentAccount.name}}资金</view>
        <view class="funds-row-center">
          <view class="fund-item-full">
            <text class="fund-label">港币余额</text>
            <text class="fund-amount hkd">{{formatter.formatAmount(currentAccountFunds.balances.HKD, 'HKD')}}</text>
          </view>
        </view>
        <view class="funds-quick-actions">
          <button class="quick-action-btn deposit" bindtap="onFundRecord" data-type="deposit">
            <text class="btn-icon">+</text>
            <text class="btn-text">转入</text>
          </button>
          <button class="quick-action-btn withdraw" bindtap="onFundRecord" data-type="withdraw">
            <text class="btn-icon">-</text>
            <text class="btn-text">转出</text>
          </button>
          <button class="quick-action-btn detail" bindtap="onFundDetail">
            <text class="btn-icon">📊</text>
            <text class="btn-text">详情</text>
          </button>
        </view>
      </view>
    </view>

    <!-- 账户管理 -->
    <view class="menu-title">账户管理</view>
    
    <view class="menu-list">
      <view class="menu-item" bindtap="onFundManagement">
        <view class="menu-content">
          <text class="menu-icon">💰</text>
          <text class="menu-text">资金管理</text>
          <text class="menu-desc">账户资金流水</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="onManageAccounts">
        <view class="menu-content">
          <text class="menu-icon">👤</text>
          <text class="menu-text">管理账户</text>
          <text class="menu-desc">{{accountList.length}}个账户</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="onAbout">
        <view class="menu-content">
          <text class="menu-icon">ℹ️</text>
          <text class="menu-text">关于应用</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      
      <view class="menu-item" bindtap="onFeedback">
        <view class="menu-content">
          <text class="menu-icon">💬</text>
          <text class="menu-text">意见反馈</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
    </view>
  </view>

  <!-- 退出按钮 -->
  <view class="logout-section" wx:if="{{userInfo}}">
    <button class="logout-btn" bindtap="onLogout">退出登录</button>
  </view>

  <!-- 账户切换弹窗 -->
  <view class="account-modal" wx:if="{{showAccountModal}}" bindtap="onCloseAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">选择账户</text>
        <button class="add-account-btn" bindtap="onAddAccount">+ 新增账户</button>
      </view>
      
      <view class="account-list">
        <view 
          class="account-item {{currentAccount.id === item.id ? 'active' : ''}}" 
          wx:for="{{accountList}}" 
          wx:key="id"
          bindtap="onSelectAccount"
          data-account="{{item}}"
        >
          <view class="account-info">
            <text class="account-name">{{item.name}}</text>
            <text class="account-desc" wx:if="{{item.isDefault}}">默认账户</text>
          </view>
          <text class="check-icon" wx:if="{{currentAccount.id === item.id}}">✓</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 新增/编辑账户弹窗 -->
  <view class="add-account-modal" wx:if="{{showAddAccountModal}}" bindtap="onCloseAddAccountModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">{{editingAccount.id ? '编辑账户' : '新增账户'}}</text>
      </view>
      
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">账户名称</text>
          <input 
            class="form-input" 
            placeholder="请输入账户名称" 
            value="{{editingAccount.name}}"
            bindinput="onAccountNameChange"
            maxlength="20"
          />
        </view>
        
        <view class="form-item" wx:if="{{!editingAccount.isDefault}}">
          <label class="checkbox-item">
            <checkbox 
              checked="{{editingAccount.setAsDefault}}" 
              bindchange="onSetDefaultChange"
            />
            <text class="checkbox-text">设为默认账户</text>
          </label>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="onCloseAddAccountModal">取消</button>
        <button 
          class="btn-confirm" 
          bindtap="onSaveAccount"
          disabled="{{!editingAccount.name}}"
        >
          保存
        </button>
      </view>
    </view>
  </view>

  <!-- 修改用户信息弹窗 -->
  <view wx:if="{{showUserInfoModal}}" class="modal-overlay">
    <view class="auth-modal">
      <view class="modal-header">
        <text class="modal-title">修改个人信息</text>
        <text class="modal-desc">请设置您的头像和昵称</text>
      </view>
      
      <view class="modal-body">
        <!-- 头像选择 -->
        <view class="avatar-section">
          <text class="section-label">头像</text>
          <button 
            class="avatar-button" 
            open-type="chooseAvatar" 
            bindchooseavatar="onChooseAvatar"
          >
            <image class="avatar-preview" src="{{tempAvatarUrl}}" mode="aspectFill"></image>
            <view class="avatar-tips">点击选择头像</view>
          </button>
        </view>
        
        <!-- 昵称输入 -->
        <view class="nickname-section">
          <text class="section-label">昵称</text>
          <input 
            class="nickname-input" 
            type="nickname" 
            placeholder="请输入昵称（1-20个字符）"
            value="{{tempNickname}}"
            bindinput="onNicknameInput"
            maxlength="20"
          />
        </view>
      </view>
      
      <view class="modal-footer">
        <button 
          class="btn-cancel" 
          bindtap="cancelUserInfo"
        >
          取消
        </button>
        <button 
          class="btn-confirm" 
          bindtap="confirmUserInfo"
          disabled="{{!tempNickname}}"
        >
          确认修改
        </button>
      </view>
    </view>
  </view>
</view>
