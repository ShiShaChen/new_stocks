# 中签结果页面扣费信息显示和状态更新修复说明

## 修正时间
2025年7月16日

## 问题描述
1. **扣费信息不显示**：当中签股数为0时，费用明细部分不显示
2. **状态未更新**：保存中签结果后，首页状态没有变更为"修改中签"和"录入卖出"状态

## 根本原因分析

### 1. 费用信息显示问题
**原因**：WXML中的费用明细被包含在条件判断中
```wxml
<!-- 问题代码 -->
<view class="result-preview" wx:if="{{formData.winningShares > 0}}">
  <!-- 费用明细在这里面，当中签股数为0时不显示 -->
</view>
```

### 2. 状态更新问题
**原因**：保存中签结果时没有更新股票状态
```javascript
// 问题代码：缺少status字段
stocks[stockIndex] = {
  ...stocks[stockIndex],
  winningShares: winningData.winningShares,
  winningTime: winningData.winningTime,
  winningFeeDetails: winningData.winningFeeDetails
  // 缺少：status: 'ongoing'
}
```

## 修复方案

### 1. 费用信息显示修复

#### WXML修复
**修改前：**
```wxml
<view class="result-preview" wx:if="{{formData.winningShares > 0}}">
  <!-- 费用明细 -->
</view>
```

**修改后：**
```wxml
<!-- 计算结果预览 - 始终显示 -->
<view class="result-preview">
  <!-- 费用明细 - 始终显示 -->
</view>
```

#### JavaScript逻辑修复
**修改前：**
```javascript
if (stock.winningShares >= 0 && stock.winningTime) {
  // 只有有记录时才计算
  this.calculateResult()
}
```

**修改后：**
```javascript
if (stock.winningShares >= 0 && stock.winningTime) {
  this.calculateResult()
} else {
  // 即使没有中签记录，也要初始化费用计算
  this.calculateResult()
}
```

### 2. 状态更新修复

**修改前：**
```javascript
stocks[stockIndex] = {
  ...stocks[stockIndex],
  winningShares: winningData.winningShares,
  winningTime: winningData.winningTime,
  winningFeeDetails: winningData.winningFeeDetails
}
```

**修改后：**
```javascript
stocks[stockIndex] = {
  ...stocks[stockIndex],
  winningShares: winningData.winningShares,
  winningTime: winningData.winningTime,
  winningFeeDetails: winningData.winningFeeDetails,
  status: 'ongoing'  // 确保有中签记录后状态为进行中
}
```

## 修复效果

### 1. 费用信息正确显示
- ✅ 中签股数为0时，费用明细正常显示
- ✅ 打新套餐费用始终显示
- ✅ 其他基于比例的费用在中签股数为0时显示为0.00
- ✅ 总费用显示为套餐费用

### 2. 首页状态正确更新
- ✅ 保存中签结果后，股票状态更新为'ongoing'
- ✅ 首页显示"修改中签"按钮（而不是"录入中签"）
- ✅ 如果中签股数>0，显示"录入卖出"按钮

## 文件修改列表
1. **pages/winning-result/winning-result.js**：
   - 修改 `saveWinningResult` 方法，添加状态更新
   - 修改 `loadStockInfo` 方法，确保初始化时计算费用

2. **pages/winning-result/winning-result.wxml**：
   - 移除费用明细的条件显示限制
   - 确保费用信息始终显示

## 业务流程验证

### 中签股数 > 0 的情况：
1. 进入页面 → 显示费用明细（包含所有费用项目）
2. 保存 → 状态更新为'ongoing'
3. 返回首页 → 显示"修改中签"和"录入卖出"按钮

### 中签股数 = 0 的情况：
1. 进入页面 → 显示费用明细（只有套餐费用>0，其他为0）
2. 保存 → 状态更新为'ongoing' 
3. 返回首页 → 显示"修改中签"按钮（不显示"录入卖出"按钮）

## 测试建议
1. 测试录入中签0股，确认费用明细正确显示
2. 测试录入中签>0股，确认费用明细正确显示
3. 测试保存后返回首页，确认按钮状态正确
4. 测试修改已有中签记录，确认状态保持一致

这次修复确保了中签0股功能的完整性，用户现在可以看到完整的费用信息，首页状态也会正确更新！
