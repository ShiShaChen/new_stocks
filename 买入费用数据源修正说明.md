# 买入费用数据源修正说明

## 问题识别
用户指出买入费用应该来自"录入中签页面的总费用"，而不是简单的serviceFee + packageFee。

## 问题分析

### 原有逻辑问题
```javascript
// 错误：使用add-stock页面的serviceFee + packageFee
const buyFees = (serviceFee + packageFee) * buyFeeRatio
```

### 正确逻辑
买入费用应该来自中签结果页面计算的总费用，该费用包括：
- 印花税 (0.1%)
- 交易费 (0.00565%)
- 交易征费 (0.0027%)
- 会财局交易征费 (0.00015%)
- 套餐费用

## 修正内容

### 1. 中签结果页面修正
增加保存费用明细到股票记录：

```javascript
// 保存中签费用明细
this.saveWinningResult({
  winningShares: winningShares,
  winningTime: winningDateTime.getTime(),
  winningFeeDetails: this.data.feeDetails  // 新增
})

// 存储到股票记录
stocks[stockIndex] = {
  ...stocks[stockIndex],
  winningShares: winningData.winningShares,
  winningTime: winningData.winningTime,
  winningFeeDetails: winningData.winningFeeDetails  // 新增
}
```

### 2. 卖出信息页面修正
使用中签页面保存的总费用作为买入费用：

```javascript
// 买入费用使用中签页面的总费用，按比例计算
let buyFees = 0
if (this.data.stockInfo.winningFeeDetails && this.data.stockInfo.winningFeeDetails.totalFee) {
  const buyFeeRatio = sellShares / this.data.stockInfo.winningShares
  buyFees = parseFloat(this.data.stockInfo.winningFeeDetails.totalFee) * buyFeeRatio
} else {
  // 兼容旧数据：如果没有中签费用明细，使用原来的计算方式
  const buyFeeRatio = sellShares / this.data.stockInfo.winningShares
  buyFees = (serviceFee + packageFee) * buyFeeRatio
}
```

### 3. 计算逻辑确认

#### 总手续费
```javascript
总手续费 = feeDetails.totalFee (卖出费用明细的总费用)
```

#### 净盈亏计算
```javascript
净盈亏 = 卖出金额 - 成本金额 - 买入费用 - 总手续费
```

其中：
- 买入费用 = 中签页面总费用 × 卖出比例
- 总手续费 = 卖出时的各项费用之和

## 数据流程图

```
新增打新页面
├── serviceFee (服务费)
├── packageFee (套餐费)
└── 保存到股票记录

中签结果页面
├── 计算中签费用明细
│   ├── 印花税
│   ├── 交易费  
│   ├── 交易征费
│   ├── 会财局交易征费
│   └── 套餐费用
├── 计算总费用
└── 保存winningFeeDetails到股票记录

卖出信息页面
├── 读取winningFeeDetails.totalFee作为买入费用基数
├── 按卖出比例计算实际买入费用
├── 计算卖出费用明细
└── 净盈亏 = 卖出金额 - 成本金额 - 买入费用 - 卖出费用
```

## 兼容性处理

为了兼容已有数据（没有winningFeeDetails的记录），保留了回退逻辑：
```javascript
if (this.data.stockInfo.winningFeeDetails && this.data.stockInfo.winningFeeDetails.totalFee) {
  // 使用中签页面的总费用
  buyFees = parseFloat(this.data.stockInfo.winningFeeDetails.totalFee) * buyFeeRatio
} else {
  // 兼容旧数据
  buyFees = (serviceFee + packageFee) * buyFeeRatio
}
```

## 验证要点

1. **中签结果页面**
   - [ ] 保存费用明细到winningFeeDetails
   - [ ] totalFee包含所有应缴费用

2. **卖出信息页面**
   - [ ] 正确读取winningFeeDetails.totalFee
   - [ ] 按比例计算买入费用
   - [ ] 旧数据兼容性正常

3. **数据一致性**
   - [ ] 买入费用来源明确
   - [ ] 计算逻辑清晰
   - [ ] 前后数据关联正确

---
*修正时间：2025年7月12日*
*状态：已修正，需重新录入中签结果以获得完整数据*
