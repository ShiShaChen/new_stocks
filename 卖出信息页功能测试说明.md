# 卖出信息页功能测试和问题排查

## 功能修复总结

### ✅ 已完成修复
1. **WXML模板语法错误修复**
   - 移除了`Math.abs(profit).toFixed(2)`等JavaScript方法调用
   - 改为直接显示`{{profit}}`，由JS计算时已格式化

2. **费用计算逻辑完善**
   - 交易费正确加入总费用计算
   - 总费用 = 印花税 + 交易徵费 + 交易费 + 结算费 + 佣金

3. **显示条件优化**
   - 改进了结果预览的显示条件判断
   - 确保有卖出价格时就显示计算结果

4. **调试日志增强**
   - 添加详细的计算过程日志
   - 便于排查计算问题

### 📊 费用计算规则验证

#### 费率配置
- **佣金**：75港元（固定）
- **印花税**：0.1% (baseAmount * 0.001)
- **交易徵费**：0.00285% (baseAmount * 0.0000285)
- **交易费**：0.00565% (baseAmount * 0.0000565)
- **结算费**：0.002% (baseAmount * 0.00002)，最低3港元

#### 计算基数
- 所有费用按：中签数量 × 卖出价格

#### 示例计算 (假设1000股，卖出价格10港元)
```
基数金额 = 1000 × 10 = 10,000港元

佣金 = 75.00港元
印花税 = 10,000 × 0.001 = 10.00港元
交易徵费 = 10,000 × 0.0000285 = 0.29港元
交易费 = 10,000 × 0.0000565 = 0.57港元
结算费 = max(10,000 × 0.00002, 3.00) = max(0.20, 3.00) = 3.00港元

卖出费用合计 = 75.00 + 10.00 + 0.29 + 0.57 + 3.00 = 88.86港元
```

### 🔧 技术实现要点

#### 1. 精度处理
```javascript
const stampDuty = Math.round(baseAmount * 0.001 * 100) / 100
```
使用Math.round确保四舍五入到两位小数

#### 2. 结算费特殊处理
```javascript
let settlementFee = Math.round(baseAmount * 0.00002 * 100) / 100
if (settlementFee < 3.00) {
  settlementFee = 3.00
}
```

#### 3. 数据格式化
- 所有金额在JS中计算时转为字符串
- WXML中直接显示，避免模板中的复杂计算

### 🎯 用户界面优化

#### 1. 实时计算反馈
- 输入卖出价格后立即显示费用明细
- 清晰的费用项目分解显示

#### 2. 费用明细展示
- 佣金：固定显示75.00
- 各项税费：显示费率和计算结果
- 总费用：突出显示

#### 3. 盈亏计算
- 净盈亏 = 卖出金额 - 成本金额 - 总费用
- 收益率 = (净盈亏 / 成本金额) × 100%

### 🧪 测试建议

#### 1. 基本功能测试
- [ ] 输入卖出价格，检查是否立即显示计算结果
- [ ] 验证各项费用计算的准确性
- [ ] 测试结算费3元最低限制

#### 2. 边界值测试
- [ ] 极小金额（如1港元）的费用计算
- [ ] 大金额的精度处理
- [ ] 部分卖出的比例计算

#### 3. 数据一致性测试
- [ ] 保存后的数据完整性
- [ ] 与其他页面数据的同步

### 🐛 可能的问题点

#### 1. 显示问题
- 检查小程序开发工具中的控制台日志
- 确认数据绑定是否正确

#### 2. 计算精度
- 验证浮点数运算的精度
- 确认所有费率计算正确

#### 3. 数据存储
- 确认费用明细正确保存
- 验证数据结构兼容性

### 📝 调试步骤

1. **打开小程序开发工具**
2. **进入卖出信息页面**
3. **输入测试数据**：
   - 卖出价格：10.00
   - 卖出股数：1000
4. **查看控制台日志**：检查"=== 卖出计算调试信息 ==="
5. **验证界面显示**：确认所有费用项目正确显示
6. **测试保存功能**：确认数据正确保存

---
*测试时间：2025年7月12日*
*状态：待验证*
