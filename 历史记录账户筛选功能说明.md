# 历史记录页面账户筛选功能说明

## 功能概述
在历史记录页面新增账户筛选功能，用户可以选择查看特定账户的打新记录，默认显示"全部"账户的记录。

## 功能特点

### 1. 筛选选项
- **默认选项**: "全部" - 显示所有账户的记录
- **账户选项**: 动态加载用户创建的所有打新账户
- **实时筛选**: 选择账户后立即更新列表和统计信息

### 2. 界面布局
- 在原有的时间筛选和状态筛选基础上新增账户筛选
- 筛选条件按行排列，保持界面整洁
- 账户筛选器样式与状态筛选器保持一致

### 3. 数据展示
- 每条记录显示所属账户名称
- 账户名称以标签形式展示，便于识别
- 统计信息按筛选条件动态计算

## 技术实现

### 1. 数据结构修改

#### 页面数据新增字段
```javascript
data: {
  // 新增账户筛选相关字段
  accountFilterIndex: 0,           // 当前选中的账户筛选索引
  accountFilterOptions: ['全部'],   // 账户筛选选项数组
  accountList: [],                 // 完整的账户列表
  
  // 原有字段...
}
```

### 2. 核心方法实现

#### 账户初始化
```javascript
initializeAccounts() {
  const accounts = wx.getStorageSync('accounts') || []
  
  // 确保有默认账户
  if (accounts.length === 0) {
    const defaultAccount = {
      id: 'default',
      name: '默认账户',
      isDefault: true,
      createTime: new Date().getTime()
    }
    accounts.push(defaultAccount)
    wx.setStorageSync('accounts', accounts)
  }

  // 构建筛选选项
  const accountOptions = ['全部']
  accounts.forEach(account => {
    accountOptions.push(account.name)
  })

  this.setData({
    accountList: accounts,
    accountFilterOptions: accountOptions
  })
}
```

#### 数据加载优化
```javascript
loadAllData() {
  const stocks = wx.getStorageSync('stocks') || []
  
  // 处理数据时添加账户名称
  const processedStocks = stocks.map(stock => {
    const processedStock = { ...stock }
    
    // 添加账户名称显示
    const accountId = stock.accountId || 'default'
    const account = this.data.accountList.find(acc => acc.id === accountId)
    processedStock.accountName = account ? account.name : '默认账户'
    
    return processedStock
  })
  
  // 移除原有的按当前账户过滤逻辑，改为显示全部数据
}
```

#### 筛选逻辑增强
```javascript
filterAndDisplayData() {
  let filtered = [...this.data.allStocks]

  // 原有的时间和状态筛选...
  
  // 新增账户筛选
  const accountFilter = this.data.accountFilterOptions[this.data.accountFilterIndex]
  if (accountFilter !== '全部') {
    const selectedAccount = this.data.accountList.find(acc => acc.name === accountFilter)
    if (selectedAccount) {
      filtered = filtered.filter(stock => {
        const stockAccountId = stock.accountId || 'default'
        return stockAccountId === selectedAccount.id
      })
    }
  }
  
  // 计算统计信息和分页显示...
}
```

#### 事件处理
```javascript
// 账户筛选变更
onAccountFilterChange(e) {
  this.setData({
    accountFilterIndex: parseInt(e.detail.value),
    currentPage: 1  // 重置到第一页
  })
  this.filterAndDisplayData()
}

// 重置筛选
resetFilter() {
  this.setData({
    startDate: '',
    endDate: '',
    statusFilterIndex: 0,
    accountFilterIndex: 0,  // 重置账户筛选
    currentPage: 1
  })
  this.filterAndDisplayData()
}
```

### 3. 界面实现

#### WXML结构
```xml
<!-- 新增账户筛选行 -->
<view class="filter-row">
  <view class="filter-item">
    <text class="filter-label">账户筛选：</text>
    <picker bindchange="onAccountFilterChange" value="{{accountFilterIndex}}" range="{{accountFilterOptions}}">
      <view class="account-picker">{{accountFilterOptions[accountFilterIndex]}}</view>
    </picker>
  </view>
  
  <button class="btn-reset" bindtap="resetFilter">重置</button>
</view>

<!-- 记录列表中显示账户信息 -->
<view class="stock-header">
  <text class="stock-name">{{item.stockName}}</text>
  <text class="stock-account">{{item.accountName}}</text>
  <text class="stock-status status-{{item.status}}">...</text>
  <text class="stock-date">{{item.createTimeStr}}</text>
</view>
```

#### WXSS样式
```css
/* 账户选择器样式 */
.account-picker {
  color: #007aff;
  font-size: 28rpx;
  padding: 10rpx 15rpx;
  border: 1rpx solid #ddd;
  border-radius: 8rpx;
  min-width: 120rpx;
  text-align: center;
}

/* 账户标签样式 */
.stock-account {
  font-size: 22rpx;
  color: #666;
  background-color: #f5f5f5;
  padding: 6rpx 12rpx;
  border-radius: 12rpx;
  margin: 0 10rpx;
  white-space: nowrap;
}

/* 股票名称适配 */
.stock-name {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
  flex: 1;  /* 占据剩余空间 */
}
```

## 用户体验优化

### 1. 筛选逻辑
- **默认全部**: 进入页面时默认显示所有账户的记录
- **动态选项**: 账户选项根据实际创建的账户动态生成
- **实时更新**: 切换筛选条件时立即更新数据和统计

### 2. 视觉设计
- **一致性**: 账户筛选器样式与其他筛选器保持一致
- **标识清晰**: 每条记录的账户标签显眼但不突兀
- **布局合理**: 筛选条件分行排列，避免拥挤

### 3. 交互反馈
- **重置功能**: 一键重置所有筛选条件
- **状态保持**: 筛选条件在页面内保持
- **数据同步**: 筛选后的统计信息准确计算

## 与现有功能的整合

### 1. 兼容性
- **向后兼容**: 旧数据自动归类到默认账户
- **数据完整**: 确保所有记录都有对应的账户信息
- **功能独立**: 不影响原有的时间和状态筛选

### 2. 数据一致性
- **账户同步**: 账户列表与其他页面保持同步
- **统计准确**: 筛选后的统计信息实时计算
- **分页支持**: 筛选后重新分页显示

### 3. 性能优化
- **按需加载**: 账户列表仅在需要时加载
- **高效筛选**: 使用高效的数组筛选方法
- **内存管理**: 避免重复数据存储

## 测试要点

### 1. 功能测试
- [ ] 账户筛选选项正确显示
- [ ] 选择不同账户时数据正确过滤
- [ ] "全部"选项显示所有账户数据
- [ ] 重置功能正常工作

### 2. 数据测试
- [ ] 多账户数据正确分离
- [ ] 统计信息按筛选条件计算
- [ ] 账户名称正确显示
- [ ] 缺失账户ID的数据处理

### 3. 界面测试
- [ ] 筛选器样式一致美观
- [ ] 账户标签显示清晰
- [ ] 布局在不同屏幕尺寸下正常
- [ ] 交互响应及时

### 4. 边界测试
- [ ] 无账户时的处理
- [ ] 账户删除后的数据显示
- [ ] 大量账户时的性能
- [ ] 筛选组合的正确性

## 后续优化建议

### 1. 功能增强
- 支持多账户同时筛选
- 添加账户快速切换按钮
- 记住用户的筛选偏好

### 2. 性能优化
- 实现虚拟列表支持大数据量
- 优化筛选算法性能
- 增加数据缓存机制

### 3. 用户体验
- 添加筛选结果的动画效果
- 提供筛选结果的快速导出
- 增加搜索功能

通过本次功能增强，历史记录页面现在支持按账户筛选，为用户提供了更加灵活和便捷的数据查看方式，特别适合管理多个投资账户的用户需求。
